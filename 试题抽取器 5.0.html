<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能面试题本系统 Pro - 优化版 v3.2</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
            /* 性能优化 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            will-change: scroll-position;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            /* 硬件加速优化 */
            transform: translateZ(0);
            backface-visibility: hidden;
            will-change: transform;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            color: white;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
            text-shadow: 0 1px 5px rgba(0,0,0,0.3);
        }

        .header-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .header-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        /* 分析按钮箭头指示器 */
        .header-btn.analysis-btn::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid rgba(255,255,255,0.8);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .header-btn.analysis-btn.show-arrow::after {
            opacity: 1;
            animation: arrowPulse 1.5s ease-in-out infinite;
        }

        @keyframes arrowPulse {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(3px); }
        }

        /* 优化的筛选器 - 现代化设计 */
        .modern-filter-section {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .filter-toggle-btn {
            width: 100%;
            padding: 15px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .filter-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .filter-toggle-btn .toggle-icon {
            transition: transform 0.3s ease;
        }

        .filter-toggle-btn.active .toggle-icon {
            transform: rotate(180deg);
        }

        .filter-content {
            margin-top: 20px;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .filter-content.show {
            opacity: 1;
            max-height: 600px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .filter-group {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .filter-group:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .filter-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .filter-group-title {
            font-size: 1rem;
            font-weight: 700;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group-title i {
            color: #667eea;
            font-size: 1.1rem;
        }

        .filter-controls {
            display: flex;
            gap: 8px;
        }

        .filter-control-btn {
            padding: 6px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
            /* 硬件加速优化 */
            transform: translateZ(0);
            backface-visibility: hidden;
            will-change: transform, box-shadow;
        }

        .filter-control-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .filter-control-btn.clear {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            box-shadow: 0 2px 8px rgba(149, 165, 166, 0.2);
        }

        .filter-control-btn.clear:hover {
            box-shadow: 0 4px 12px rgba(149, 165, 166, 0.3);
        }

        .filter-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px;
        }

        .filter-option {
            display: flex;
            align-items: center;
            padding: 10px 14px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-weight: 500;
            color: #2c3e50;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            /* 硬件加速优化 */
            transform: translateZ(0);
            backface-visibility: hidden;
            will-change: transform, background-color, border-color, box-shadow;
        }

        .filter-option:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(102, 126, 234, 0.15);
        }

        .filter-option.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .filter-option input[type="checkbox"] {
            margin-right: 8px;
            accent-color: #667eea;
            width: 16px;
            height: 16px;
        }

        .filter-stats {
            margin-top: 15px;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 10px;
            font-size: 0.9rem;
            color: #667eea;
            font-weight: 600;
            text-align: center;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* Top Actions Row */
        .top-actions-row {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr;
            gap: 20px;
            height: 280px;
        }

        .core-action-btn {
            padding: 30px;
            border: none;
            border-radius: 20px;
            font-size: 1.3rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
            text-decoration: none;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            /* 硬件加速优化 */
            transform: translateZ(0);
            backface-visibility: hidden;
            will-change: transform, box-shadow;
        }

        .core-action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .core-action-btn:hover::before {
            left: 100%;
        }

        .core-action-btn i {
            font-size: 3.5rem;
        }

        .btn-draw-question {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .btn-draw-student {
            background: linear-gradient(135deg, #4834d4 0%, #686de0 100%);
        }

        .core-action-btn:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
        }

        .core-action-btn:active {
            transform: translateY(-4px);
        }

        /* 优化的套题模式选择器 - 更紧凑的设计 */
        .question-mode-selector {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 3px;
            background: rgba(255,255,255,0.2);
            padding: 4px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .mode-option {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            /* 硬件加速优化 */
            transform: translateZ(0);
            backface-visibility: hidden;
            will-change: transform, background-color;
        }

        .mode-option.active {
            background: rgba(255,255,255,0.5);
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .mode-option:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Student List */
        .student-section {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            height: 280px;
        }

        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .student-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .student-count {
            background: #667eea;
            color: white;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .student-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .student-toggle-btn {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            /* 硬件加速优化 */
            transform: translateZ(0);
            backface-visibility: hidden;
            will-change: transform, background-color;
        }

        .student-toggle-btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        /* 学员分析按钮箭头指示器 */
        .student-toggle-btn.analysis-btn::after {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid #667eea;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .student-toggle-btn.analysis-btn.show-arrow::after {
            opacity: 1;
            animation: arrowPulse 1.5s ease-in-out infinite;
        }

        .student-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            padding: 5px;
        }

        .student-list.list-view {
            grid-template-columns: 1fr;
        }

        .student-list.expanded {
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
            /* 硬件加速优化 */
            transform: translateZ(0);
            backface-visibility: hidden;
            will-change: transform, background-color, box-shadow;
        }

        .student-item:hover {
            background: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .student-item.selected {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
            animation: selectedPulse 2s infinite;
        }

        .student-item.just-selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            animation: justSelected 3s ease-in-out;
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .student-item.focused {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.3);
        }

        /* 学员选中后的箭头指示器 */
        .student-item.selected::after {
            content: '';
            position: absolute;
            top: -8px;
            right: 10px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid #667eea;
            animation: arrowPulse 1.5s ease-in-out infinite;
        }

        @keyframes selectedPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(102, 126, 234, 0); }
        }

        @keyframes justSelected {
            0% { 
                transform: scale(1);
                background: #f8f9fa;
                color: #333;
            }
            20% { 
                transform: scale(1.1);
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
            }
            80% { 
                transform: scale(1.05);
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
            }
            100% { 
                transform: scale(1);
                background: rgba(102, 126, 234, 0.1);
                color: #333;
            }
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: #333;
        }

        .student-stats {
            font-size: 0.8rem;
            opacity: 0.7;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .student-badge {
            background: #667eea;
            color: white;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 700;
            min-width: 30px;
            text-align: center;
        }

        .student-progress {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* Bottom Content Row */
        .bottom-content-row {
            display: grid;
            grid-template-columns: 1fr 450px;
            gap: 25px;
            flex: 1;
            position: relative;
        }

        /* 答题卡片散落区域 */
        .question-cards-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .answered-question-card {
            position: absolute;
            width: 120px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 10px;
            color: white;
            font-size: 0.7rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: pointer;
            pointer-events: all;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            animation: cardFallIn 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: transform, opacity;
            backface-visibility: hidden;
            transform-style: preserve-3d;
        }

        .answered-question-card:hover {
            transform: scale(1.05) translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            z-index: 20;
        }

        .answered-question-card .card-student {
            font-weight: 700;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .answered-question-card .card-question {
            flex: 1;
            overflow: hidden;
            line-height: 1.2;
        }

        .answered-question-card .card-performance {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
            font-size: 0.6rem;
        }

        .answered-question-card .performance-score {
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 600;
        }

        @keyframes cardFallIn {
            0% {
                opacity: 0;
                transform: translateY(-200px) rotate(-15deg) scale(0.6);
                filter: blur(5px);
            }
            30% {
                opacity: 0.7;
                transform: translateY(-50px) rotate(8deg) scale(1.05);
                filter: blur(2px);
            }
            60% {
                opacity: 0.9;
                transform: translateY(10px) rotate(-3deg) scale(1.02);
                filter: blur(1px);
            }
            80% {
                opacity: 1;
                transform: translateY(-5px) rotate(1deg) scale(0.98);
                filter: blur(0px);
            }
            100% {
                opacity: 1;
                transform: translateY(0) rotate(0deg) scale(1);
                filter: blur(0px);
            }
        }

        /* 聚焦模式样式 */
        .focus-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .focus-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            max-width: 1400px;
            width: 100%;
            height: 80vh;
            animation: focusSlideIn 0.5s ease-out;
        }

        @keyframes focusSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .focus-question {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            overflow-y: auto;
            border: 3px solid #667eea;
            animation: questionGlow 2s ease-in-out infinite alternate;
        }

        .focus-timer {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border: 3px solid #ff6b6b;
            animation: timerGlow 2s ease-in-out infinite alternate;
        }

        @keyframes questionGlow {
            0% { box-shadow: 0 20px 60px rgba(0,0,0,0.3), 0 0 0 0 rgba(102, 126, 234, 0.4); }
            100% { box-shadow: 0 20px 60px rgba(0,0,0,0.3), 0 0 0 8px rgba(102, 126, 234, 0.2); }
        }

        @keyframes timerGlow {
            0% { box-shadow: 0 20px 60px rgba(0,0,0,0.3), 0 0 0 0 rgba(255, 107, 107, 0.4); }
            100% { box-shadow: 0 20px 60px rgba(0,0,0,0.3), 0 0 0 8px rgba(255, 107, 107, 0.2); }
        }

        .focus-exit {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .focus-exit:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        /* Question Display */
        .question-display {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            min-height: 450px;
            display: flex;
            flex-direction: column;
        }

        /* 套题显示 */
        .question-set-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
        }

        .set-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .question-nav {
            display: flex;
            gap: 8px;
        }

        .nav-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-dot.active {
            background: white;
            transform: scale(1.2);
        }

        .nav-dot.completed {
            background: #27ae60;
        }

        .question-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .meta-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .question-text {
            font-size: 1.3rem;
            line-height: 1.7;
            color: #333;
            font-weight: 500;
            flex: 1;
        }

        .question-placeholder {
            text-align: center;
            color: #666;
            font-style: italic;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .question-placeholder i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* Timer Section - 移除本轮记录功能 */
        .timer-section {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            min-height: 450px;
            position: relative;
        }

        .timer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .timer-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timer-reset-btn {
            padding: 6px 12px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .timer-reset-btn:hover {
            background: #7f8c8d;
            transform: translateY(-1px);
        }

        .timer-display {
            font-size: 3.5rem;
            font-weight: 800;
            margin: 20px 0;
            font-family: 'SF Mono', Monaco, monospace;
            color: #667eea;
            text-align: center;
            /* 硬件加速优化 */
            transform: translateZ(0);
            backface-visibility: hidden;
            will-change: contents;
        }

        .timer-phase {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .timer-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .timer-btn {
            padding: 12px 15px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            /* 硬件加速优化 */
            transform: translateZ(0);
            backface-visibility: hidden;
            will-change: transform;
        }

        .timer-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .timer-btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .timer-btn-start {
            background: #27ae60;
            color: white;
        }

        .timer-btn-answer {
            background: #f39c12;
            color: white;
        }

        .timer-btn-finish {
            background: #e74c3c;
            color: white;
        }

        .timer-answer-btn {
            background: #3498db;
            color: white;
            margin-top: 10px;
            grid-column: 1 / -1;
            padding: 12px 15px;
        }

        /* 优化的计时器状态显示 */
        .timer-status {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 15px;
            margin-top: auto;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            /* 硬件加速优化 */
            transform: translateZ(0);
            backface-visibility: hidden;
            will-change: background-color, border-color;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #667eea;
        }

        .status-indicator i {
            font-size: 1.2rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* 优化的随机抽题动画 */
        .question-roulette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .question-card-container {
            text-align: center;
            max-width: 800px;
            width: 90%;
        }

        .question-card-title {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 40px;
            color: #ff6b6b;
            opacity: 0;
            animation: titleFadeIn 0.8s ease-out 0.2s forwards;
        }

        @keyframes titleFadeIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-deck {
            position: relative;
            width: 400px;
            height: 250px;
            margin: 0 auto 40px;
            perspective: 1200px;
        }

        .card-stack {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .card-item {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
        }

        .card-item:nth-child(1) { transform: translateZ(0px) rotateZ(0deg); z-index: 10; }
        .card-item:nth-child(2) { transform: translateZ(-10px) rotateZ(-2deg); z-index: 9; }
        .card-item:nth-child(3) { transform: translateZ(-20px) rotateZ(1deg); z-index: 8; }
        .card-item:nth-child(4) { transform: translateZ(-30px) rotateZ(-1deg); z-index: 7; }
        .card-item:nth-child(5) { transform: translateZ(-40px) rotateZ(2deg); z-index: 6; }

        .card-item.shuffling {
            animation: cardShuffle 0.8s ease-in-out;
        }

        .card-item.selected {
            animation: cardSelect 1.2s ease-out forwards;
            z-index: 20;
        }

        @keyframes cardShuffle {
            0% { transform: translateZ(0px) rotateZ(0deg); }
            25% { transform: translateZ(50px) rotateZ(10deg) translateX(100px); }
            50% { transform: translateZ(100px) rotateZ(-15deg) translateX(-50px); }
            75% { transform: translateZ(50px) rotateZ(5deg) translateX(30px); }
            100% { transform: translateZ(0px) rotateZ(0deg); }
        }

        @keyframes cardSelect {
            0% { 
                transform: translateZ(0px) rotateZ(0deg) scale(1);
                opacity: 1;
            }
            30% { 
                transform: translateZ(100px) rotateZ(5deg) scale(1.1);
                opacity: 1;
            }
            60% { 
                transform: translateZ(200px) rotateZ(0deg) scale(1.2);
                opacity: 0.9;
            }
            100% { 
                transform: translateZ(300px) rotateZ(0deg) scale(1.3);
                opacity: 0;
            }
        }

        .question-countdown {
            font-size: 1.4rem;
            margin-top: 30px;
            opacity: 0.9;
            animation: countdownPulse 1.5s ease-in-out infinite;
        }

        @keyframes countdownPulse {
            0%, 100% { opacity: 0.9; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        /* Random Student Roulette */
        .student-roulette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .roulette-container {
            text-align: center;
            max-width: 600px;
            width: 90%;
        }

        .roulette-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 40px;
            color: #667eea;
            text-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }

        .roulette-wheel {
            width: 300px;
            height: 300px;
            border: 8px solid #667eea;
            border-radius: 50%;
            margin: 0 auto 40px;
            position: relative;
            background: linear-gradient(45deg, #667eea, #764ba2, #667eea, #764ba2);
            background-size: 400% 400%;
            animation: gradientShift 3s ease-in-out infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 50px rgba(102, 126, 234, 0.3);
        }

        .roulette-name {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            animation: nameFlip 0.3s ease-in-out;
        }

        .roulette-countdown {
            font-size: 1.5rem;
            margin-top: 20px;
            opacity: 0.8;
        }

        .roulette-result {
            font-size: 3rem;
            font-weight: 800;
            color: #667eea;
            margin-top: 30px;
            text-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
            animation: resultPulse 1s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes nameFlip {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(90deg); }
            100% { transform: rotateY(0deg); }
        }

        @keyframes resultPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Performance Evaluation Modal */
        .evaluation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            z-index: 2500;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .evaluation-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: evaluationSlideIn 0.4s ease-out;
        }

        @keyframes evaluationSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .evaluation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .evaluation-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-evaluation {
            background: #f8f9fa;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #666;
            transition: all 0.3s ease;
        }

        .close-evaluation:hover {
            background: #e9ecef;
            color: #333;
        }

        .evaluation-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .evaluation-item {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .evaluation-label {
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }

        .evaluation-options {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .evaluation-option {
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            background: #f8f9fa;
            cursor: pointer;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .evaluation-option:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .evaluation-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .evaluation-option.excellent.selected {
            background: #27ae60;
            border-color: #27ae60;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .evaluation-option.good.selected {
            background: #3498db;
            border-color: #3498db;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .evaluation-option.average.selected {
            background: #f39c12;
            border-color: #f39c12;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }

        .evaluation-option.poor.selected {
            background: #e74c3c;
            border-color: #e74c3c;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .evaluation-option.very-poor.selected {
            background: #8e44ad;
            border-color: #8e44ad;
            box-shadow: 0 4px 15px rgba(142, 68, 173, 0.3);
        }

        .evaluation-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .eval-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .eval-btn-clear {
            background: #95a5a6;
            color: white;
        }

        .eval-btn-save {
            background: #27ae60;
            color: white;
        }

        .eval-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* Answer Section */
        .answer-section {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .answer-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            color: #333;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .answer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .answer-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .close-answer {
            background: #f8f9fa;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #666;
            transition: all 0.3s ease;
        }

        .close-answer:hover {
            background: #e9ecef;
            color: #333;
        }

        .answer-points {
            margin-bottom: 30px;
        }

        .answer-points h4 {
            font-size: 1.3rem;
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .points-list {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            line-height: 1.8;
        }

        .answer-analysis {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .answer-analysis h4 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .answer-analysis p {
            line-height: 1.8;
            opacity: 0.95;
        }

        .answer-section.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content.large {
            max-width: 1200px;
        }

        /* Settings Modal Specific Styles */
        .settings-modal .tab-container {
            margin-bottom: 20px;
        }

        .settings-modal .tab-buttons {
            display: flex;
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 20px;
        }

        .settings-modal .tab-button {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .settings-modal .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .settings-modal .tab-content {
            display: none;
        }

        .settings-modal .tab-content.active {
            display: block;
        }

        /* Question Bank Management */
        .question-bank-section {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .question-bank-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .question-bank-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .add-question-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-question-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .question-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .question-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .question-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .question-item-title {
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .question-item-actions {
            display: flex;
            gap: 5px;
        }

        .question-item-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: #3498db;
            color: white;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .question-item-btn:hover {
            transform: translateY(-1px);
        }

        .question-item-content {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .question-item-meta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .question-item-tag {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            color: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-warning {
            background: #f39c12;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* File Upload */
        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            background: rgba(102, 126, 234, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #764ba2;
        }

        .file-upload.dragover {
            background: rgba(102, 126, 234, 0.15);
            border-color: #764ba2;
            transform: scale(1.02);
        }

        /* 学员成长图表 */
        .growth-chart {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .top-actions-row {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: 1fr 1fr;
                height: auto;
            }
            
            .student-section {
                grid-column: 1 / -1;
                height: 200px;
            }
            
            .bottom-content-row {
                grid-template-columns: 1fr;
            }

            .focus-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .filter-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .top-actions-row {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .evaluation-options {
                grid-template-columns: 1fr 1fr;
            }

            .header-controls {
                position: static;
                justify-content: center;
                margin-top: 15px;
            }

            .timer-display {
                font-size: 2.5rem;
            }

            .card-deck {
                width: 300px;
                height: 200px;
            }

            .student-list {
                grid-template-columns: 1fr;
            }

            .student-name {
                font-size: 1rem;
            }

            .filter-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .filter-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-controls">
                <button class="header-btn" onclick="openSettingsModal()">
                    <i class="fas fa-cog"></i> 设置
                </button>
                <button class="header-btn analysis-btn" id="globalAnalysisBtn" onclick="openAnalysisModal()">
                    <i class="fas fa-chart-line"></i> 分析
                </button>
            </div>
            <h1><i class="fas fa-brain"></i> 智能面试题本系统 Pro</h1>
            <p>现代化课堂互动工具 - 精准抽题 · 智能计时 · 深度分析 · 套题练习</p>
        </div>

        <!-- 现代化筛选器 -->
        <div class="modern-filter-section">
            <button class="filter-toggle-btn" id="modernFilterToggle" onclick="toggleModernFilter()">
                <div class="recording-label">
                    <i class="fas fa-filter"></i>
                    <span style="color: rgba(255, 255, 255, 0.9);">智能筛选器</span>
                </div>
                <div class="toggle-icon">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </button>
            
            <div class="filter-content" id="modernFilterContent">
                <div class="filter-grid">
                    <div class="filter-group">
                        <div class="filter-group-header">
                            <div class="filter-group-title">
                                <i class="fas fa-tags"></i>
                                知识点分类
                            </div>
                            <div class="filter-controls">
                                <button class="filter-control-btn" onclick="selectAllCategories()">全选</button>
                                <button class="filter-control-btn clear" onclick="clearAllCategories()">清空</button>
                            </div>
                        </div>
                        <div class="filter-options" id="categoryFilterOptions">
                            <!-- 动态生成 -->
                        </div>
                        <div class="filter-stats" id="categoryStats">已选择 0 个分类</div>
                    </div>
                    
                    <div class="filter-group">
                        <div class="filter-group-header">
                            <div class="filter-group-title">
                                <i class="fas fa-map-marker-alt"></i>
                                省份地区
                            </div>
                            <div class="filter-controls">
                                <button class="filter-control-btn" onclick="selectAllProvinces()">全选</button>
                                <button class="filter-control-btn clear" onclick="clearAllProvinces()">清空</button>
                            </div>
                        </div>
                        <div class="filter-options" id="provinceFilterOptions">
                            <!-- 动态生成 -->
                        </div>
                        <div class="filter-stats" id="provinceStats">已选择 0 个省份</div>
                    </div>
                    
                    <div class="filter-group">
                        <div class="filter-group-header">
                            <div class="filter-group-title">
                                <i class="fas fa-calendar-alt"></i>
                                考试年份
                            </div>
                            <div class="filter-controls">
                                <button class="filter-control-btn" onclick="selectAllYears()">全选</button>
                                <button class="filter-control-btn clear" onclick="clearAllYears()">清空</button>
                            </div>
                        </div>
                        <div class="filter-options" id="yearFilterOptions">
                            <!-- 动态生成 -->
                        </div>
                        <div class="filter-stats" id="yearStats">已选择 0 个年份</div>
                    </div>
                    
                    <div class="filter-group">
                        <div class="filter-group-header">
                            <div class="filter-group-title">
                                <i class="fas fa-hospital"></i>
                                医院类型
                            </div>
                            <div class="filter-controls">
                                <button class="filter-control-btn" onclick="selectAllHospitals()">全选</button>
                                <button class="filter-control-btn clear" onclick="clearAllHospitals()">清空</button>
                            </div>
                        </div>
                        <div class="filter-options" id="hospitalFilterOptions">
                            <!-- 动态生成 -->
                        </div>
                        <div class="filter-stats" id="hospitalStats">已选择 0 个医院类型</div>
                    </div>
                </div>
                
                <div class="filter-stats" style="margin-top: 20px; text-align: center; font-size: 1rem;">
                    <i class="fas fa-database"></i> 
                    当前筛选结果：<span id="filteredQuestionCount">0</span> 道题目
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Actions Row -->
            <div class="top-actions-row">
                <button class="core-action-btn btn-draw-student" onclick="drawRandomStudent()">
                    <i class="fas fa-user-graduate"></i>
                    <span>随机抽人</span>
                </button>
                
                <div class="core-action-btn btn-draw-question" style="position:relative;" tabindex="0">
                    <i class="fas fa-dice"></i>
                    <span>随机抽题</span>
                    <div class="question-mode-selector">
                        <button class="mode-option active" data-mode="1">1</button>
                        <button class="mode-option" data-mode="2">2</button>
                        <button class="mode-option" data-mode="3">3</button>
                        <button class="mode-option" data-mode="4">4</button>
                        <button class="mode-option" data-mode="5">5</button>
                    </div>
                </div>

                <!-- Student List -->
                <div class="student-section">
                    <div class="student-header">
                        <div class="student-title">
                            <i class="fas fa-users"></i>
                            学员列表
                        </div>
                        <div class="student-count" id="studentCount">0</div>
                    </div>
                    
                    <div class="student-controls">
                        <button class="student-toggle-btn" id="toggleStudentExpand" onclick="toggleStudentExpand()">
                            <i class="fas fa-expand"></i> 展开所有
                        </button>
                        <button class="student-toggle-btn" id="toggleStudentView" onclick="toggleStudentView()">
                            <i class="fas fa-th"></i> 网格视图
                        </button>
                        <button class="student-toggle-btn" onclick="clearStudentSelection()">
                            <i class="fas fa-times"></i> 清除选择
                        </button>
                        <button class="student-toggle-btn" onclick="showStudentGrowthChart()">
                            <i class="fas fa-chart-line"></i> 成长图表
                        </button>
                        <button class="student-toggle-btn analysis-btn" id="studentAnalysisBtn" onclick="showStudentAnalysis()">
                            <i class="fas fa-analytics"></i> 分析
                        </button>
                    </div>
                    
                    <div class="student-list" id="studentList">
                        <div style="text-align: center; color: #666; padding: 20px;">
                            <i class="fas fa-user-plus" style="font-size: 1.5rem; margin-bottom: 8px; opacity: 0.3;"></i>
                            <div style="font-size: 0.8rem;">暂无学员</div>
                            <div style="font-size: 0.7rem; margin-top: 3px;">请在设置中添加学员</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Content Row -->
            <div class="bottom-content-row">
                <!-- 答题卡片散落区域 -->
                <div class="question-cards-area" id="questionCardsArea">
                    <!-- 答题完成后的卡片将在这里显示 -->
                </div>

                <!-- Question Display -->
                <div class="question-display" id="questionDisplay">
                    <div class="question-content" id="questionContent">
                        <div class="question-placeholder">
                            <i class="fas fa-question-circle"></i>
                            <div>先点名，再抽题，今天轮到你练习</div>
                            <div style="margin-top: 10px; font-size: 0.9rem; opacity: 0.7;">支持1-5题套题模式</div>
                        </div>
                    </div>
                </div>

                <!-- Timer Section -->
                <div class="timer-section" id="timerSection">
                    <div class="timer-header">
                        <div class="timer-title">
                            <i class="fas fa-clock"></i>
                            智能计时器
                        </div>
                        <button class="timer-reset-btn" onclick="resetAll()">
                            <i class="fas fa-redo"></i>
                            <span>重新开始</span>
                        </button>
                    </div>
                    
                    <div class="timer-phase" id="timerPhase">
                        <i class="fas fa-hourglass-start"></i>
                        <span>等待开始</span>
                    </div>
                    
                    <div class="timer-display" id="timerDisplay">00:30</div>
                    
                    <div class="timer-controls">
                        <button class="timer-btn timer-btn-start" id="thinkingBtn" onclick="startThinkingTimer()">
                            <i class="fas fa-brain"></i> 思考
                        </button>
                        <button class="timer-btn timer-btn-answer" id="answeringBtn" onclick="startAnsweringTimer()" disabled>
                            <i class="fas fa-microphone"></i> 答题
                        </button>
                        <button class="timer-btn timer-btn-finish" id="finishBtn" onclick="finishAnswering()" disabled>
                            <i class="fas fa-check"></i> <span id="finishBtnText">完成</span>
                        </button>
                        <button class="timer-btn timer-answer-btn" onclick="showAnswerKey()">
                            <i class="fas fa-key"></i> 显示答案
                        </button>
                    </div>
                    
                    <!-- 优化的计时器状态显示 -->
                    <div class="timer-status" id="timerStatus">
                        <div class="status-indicator">
                            <i class="fas fa-clock"></i>
                            <span id="currentPhase">等待开始</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 聚焦模式 -->
    <div class="focus-mode" id="focusMode">
        <button class="focus-exit" onclick="exitFocusMode()">
            <i class="fas fa-times"></i>
        </button>
        <div class="focus-content">
            <div class="focus-question" id="focusQuestion">
                <!-- 题目内容将在这里显示 -->
            </div>
            <div class="focus-timer" id="focusTimer">
                <!-- 计时器内容将在这里显示 -->
            </div>
        </div>
    </div>

    <!-- Random Question Card Animation -->
    <div class="question-roulette" id="questionRoulette">
        <div class="question-card-container">
            <div class="question-card-title">
                <i class="fas fa-magic"></i> 正在从题库中抽取题目...
            </div>
            <div class="card-deck">
                <div class="card-stack" id="cardStack">
                    <div class="card-item">题目 1</div>
                    <div class="card-item">题目 2</div>
                    <div class="card-item">题目 3</div>
                    <div class="card-item">题目 4</div>
                    <div class="card-item">题目 5</div>
                </div>
            </div>
            <div class="question-countdown" id="questionCountdown"></div>
        </div>
    </div>

    <!-- Random Student Roulette -->
    <div class="student-roulette" id="studentRoulette">
        <div class="roulette-container">
            <div class="roulette-title">
                <i class="fas fa-dice"></i> 随机抽人
            </div>
            <div class="roulette-wheel" id="rouletteWheel">
                <div class="roulette-name" id="rouletteName">准备中...</div>
            </div>
            <div class="roulette-countdown" id="rouletteCountdown"></div>
            <div class="roulette-result" id="rouletteResult"></div>
        </div>
    </div>

    <!-- Performance Evaluation Modal -->
    <div class="evaluation-modal" id="evaluationModal">
        <div class="evaluation-content">
            <div class="evaluation-header">
                <div class="evaluation-title">
                    <i class="fas fa-star"></i>
                    综合表现评估
                </div>
                <button class="close-evaluation" onclick="closeEvaluationModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="evaluation-grid">
                <div class="evaluation-item">
                    <div class="evaluation-label">答题流畅性</div>
                    <div class="evaluation-options">
                        <div class="evaluation-option excellent" data-type="fluency" data-value="excellent">优秀</div>
                        <div class="evaluation-option good" data-type="fluency" data-value="good">良好</div>
                        <div class="evaluation-option average" data-type="fluency" data-value="average">一般</div>
                        <div class="evaluation-option poor" data-type="fluency" data-value="poor">需改进</div>
                        <div class="evaluation-option very-poor" data-type="fluency" data-value="very-poor">较差</div>
                    </div>
                </div>
                
                <div class="evaluation-item">
                    <div class="evaluation-label">内容深度</div>
                    <div class="evaluation-options">
                        <div class="evaluation-option excellent" data-type="depth" data-value="excellent">优秀</div>
                        <div class="evaluation-option good" data-type="depth" data-value="good">良好</div>
                        <div class="evaluation-option average" data-type="depth" data-value="average">一般</div>
                        <div class="evaluation-option poor" data-type="depth" data-value="poor">需改进</div>
                        <div class="evaluation-option very-poor" data-type="depth" data-value="very-poor">较差</div>
                    </div>
                </div>
                
                <div class="evaluation-item">
                    <div class="evaluation-label">内容完整性</div>
                    <div class="evaluation-options">
                        <div class="evaluation-option excellent" data-type="completeness" data-value="excellent">优秀</div>
                        <div class="evaluation-option good" data-type="completeness" data-value="good">良好</div>
                        <div class="evaluation-option average" data-type="completeness" data-value="average">一般</div>
                        <div class="evaluation-option poor" data-type="completeness" data-value="poor">需改进</div>
                        <div class="evaluation-option very-poor" data-type="completeness" data-value="very-poor">较差</div>
                    </div>
                </div>
                
                <div class="evaluation-item">
                    <div class="evaluation-label">专业准确性</div>
                    <div class="evaluation-options">
                        <div class="evaluation-option excellent" data-type="accuracy" data-value="excellent">优秀</div>
                        <div class="evaluation-option good" data-type="accuracy" data-value="good">良好</div>
                        <div class="evaluation-option average" data-type="accuracy" data-value="average">一般</div>
                        <div class="evaluation-option poor" data-type="accuracy" data-value="poor">需改进</div>
                        <div class="evaluation-option very-poor" data-type="accuracy" data-value="very-poor">较差</div>
                    </div>
                </div>

                <div class="evaluation-item">
                    <div class="evaluation-label">逻辑思维</div>
                    <div class="evaluation-options">
                        <div class="evaluation-option excellent" data-type="logic" data-value="excellent">优秀</div>
                        <div class="evaluation-option good" data-type="logic" data-value="good">良好</div>
                        <div class="evaluation-option average" data-type="logic" data-value="average">一般</div>
                        <div class="evaluation-option poor" data-type="logic" data-value="poor">需改进</div>
                        <div class="evaluation-option very-poor" data-type="logic" data-value="very-poor">较差</div>
                    </div>
                </div>

                <div class="evaluation-item">
                    <div class="evaluation-label">表达能力</div>
                    <div class="evaluation-options">
                        <div class="evaluation-option excellent" data-type="expression" data-value="excellent">优秀</div>
                        <div class="evaluation-option good" data-type="expression" data-value="good">良好</div>
                        <div class="evaluation-option average" data-type="expression" data-value="average">一般</div>
                        <div class="evaluation-option poor" data-type="expression" data-value="poor">需改进</div>
                        <div class="evaluation-option very-poor" data-type="expression" data-value="very-poor">较差</div>
                    </div>
                </div>

                <div class="evaluation-item">
                    <div class="evaluation-label">应变能力</div>
                    <div class="evaluation-options">
                        <div class="evaluation-option excellent" data-type="adaptability" data-value="excellent">优秀</div>
                        <div class="evaluation-option good" data-type="adaptability" data-value="good">良好</div>
                        <div class="evaluation-option average" data-type="adaptability" data-value="average">一般</div>
                        <div class="evaluation-option poor" data-type="adaptability" data-value="poor">需改进</div>
                        <div class="evaluation-option very-poor" data-type="adaptability" data-value="very-poor">较差</div>
                    </div>
                </div>

                <div class="evaluation-item">
                    <div class="evaluation-label">整体印象</div>
                    <div class="evaluation-options">
                        <div class="evaluation-option excellent" data-type="overall" data-value="excellent">优秀</div>
                        <div class="evaluation-option good" data-type="overall" data-value="good">良好</div>
                        <div class="evaluation-option average" data-type="overall" data-value="average">一般</div>
                        <div class="evaluation-option poor" data-type="overall" data-value="poor">需改进</div>
                        <div class="evaluation-option very-poor" data-type="overall" data-value="very-poor">较差</div>
                    </div>
                </div>
            </div>
            
            <div class="evaluation-actions">
                <button class="eval-btn eval-btn-clear" onclick="clearEvaluation()">
                    <i class="fas fa-eraser"></i> 清除
                </button>
                <button class="eval-btn eval-btn-save" onclick="saveEvaluation()">
                    <i class="fas fa-save"></i> 保存评估
                </button>
            </div>
        </div>
    </div>

    <!-- Answer Display -->
    <div class="answer-section" id="answerSection">
        <div class="answer-content">
            <div class="answer-header">
                <div class="answer-title">
                    <i class="fas fa-lightbulb"></i>
                    <span>答题要点</span>
                </div>
                <button class="close-answer" onclick="hideAnswerKey()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="answer-points">
                <h4><i class="fas fa-list-ul"></i> 核心要点</h4>
                <div class="points-list" id="answerPoints"></div>
            </div>
            
            <div class="answer-analysis">
                <h4><i class="fas fa-brain"></i> 参考解析</h4>
                <div id="answerAnalysis"></div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal settings-modal" id="settingsModal">
        <div class="modal-content large">
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchSettingsTab('students')">学员管理</button>
                    <button class="tab-button" onclick="switchSettingsTab('questions')">题库管理</button>
                    <button class="tab-button" onclick="switchSettingsTab('system')">系统设置</button>
                </div>

                <!-- 学员管理 -->
                <div class="tab-content active" id="studentsTab">
                    <h3>学员管理</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <h4>添加学员</h4>
                            <div class="form-group">
                                <label>学员姓名</label>
                                <input type="text" class="form-control" id="newStudentName" placeholder="输入学员姓名">
                            </div>
                            <div class="form-group">
                                <label>学员编号（可选）</label>
                                <input type="text" class="form-control" id="newStudentId" placeholder="输入学员编号">
                            </div>
                            <button class="btn btn-primary" onclick="addNewStudent()">
                                <i class="fas fa-plus"></i> 添加学员
                            </button>
                            
                            <h4 style="margin-top: 30px;">批量导入</h4>
                            <div class="file-upload" id="studentFileUpload">
                                <i class="fas fa-users" style="font-size: 2rem; color: #667eea; margin-bottom: 10px;"></i>
                                <p>拖拽学员名单文件到此处或点击选择文件</p>
                                <p style="font-size: 0.8rem; opacity: 0.7;">支持格式：TXT（每行一个姓名）、CSV</p>
                                <input type="file" id="studentFile" accept=".txt,.csv" style="display: none;">
                            </div>
                            <div style="margin-top: 15px;">
                                <label>或直接粘贴学员名单（每行一个姓名）：</label>
                                <textarea class="form-control" id="studentTextArea" rows="4" placeholder="张三&#10;李四&#10;王五"></textarea>
                                <button class="btn btn-primary" onclick="batchAddStudents()" style="margin-top: 10px;">
                                    <i class="fas fa-upload"></i> 批量添加
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <h4>学员列表</h4>
                            <div style="margin-bottom: 15px;">
                                <button class="btn btn-danger" onclick="clearAllStudents()">
                                    <i class="fas fa-trash"></i> 清空所有学员
                                </button>
                                <button class="btn btn-warning" onclick="resetAllStudentStats()">
                                    <i class="fas fa-redo"></i> 重置统计
                                </button>
                            </div>
                            <div id="modalStudentList" style="max-height: 400px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>

                <!-- 题库管理 -->
                <div class="tab-content" id="questionsTab">
                    <h3>题库管理</h3>
                    
                    <!-- 题库统计 -->
                    <div class="question-bank-section">
                        <div class="question-bank-header">
                            <div class="question-bank-title">
                                <i class="fas fa-database"></i>
                                题库概览
                            </div>
                            <button class="add-question-btn" onclick="showAddQuestionForm()">
                                <i class="fas fa-plus"></i> 新增题目
                            </button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;" id="bankTotalQuestions">0</div>
                                <div style="font-size: 0.8rem; color: #666;">题目总数</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;" id="bankCategories">0</div>
                                <div style="font-size: 0.8rem; color: #666;">知识点类别</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;" id="bankProvinces">0</div>
                                <div style="font-size: 0.8rem; color: #666;">省份数量</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;" id="bankYears">0</div>
                                <div style="font-size: 0.8rem; color: #666;">年份跨度</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button class="btn btn-danger" onclick="clearAllQuestions()">
                                <i class="fas fa-trash"></i> 清空题库
                            </button>
                        </div>
                    </div>

                    <!-- 上传题库 -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <h4>上传题库</h4>
                            <div class="file-upload" id="questionFileUpload">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #667eea; margin-bottom: 10px;"></i>
                                <p>拖拽CSV题库文件到此处或点击选择文件</p>
                                <p style="font-size: 0.8rem; opacity: 0.7;">支持格式：CSV</p>
                                <input type="file" id="csvFile" accept=".csv" style="display: none;">
                            </div>
                            <div style="margin-top: 20px;">
                                <h5>CSV文件格式说明：</h5>
                                <p style="font-size: 0.9rem; color: #666;">请确保CSV文件包含以下列：省份、城市、年份、医院/单位、知识点分类、题目、答题要点、参考解析</p>
                            </div>
                        </div>
                        
                        <div>
                            <h4>题目列表</h4>
                            <div class="question-list" id="questionList">
                                <!-- 题目列表将在这里动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 系统设置 -->
                <div class="tab-content" id="systemTab">
                    <h3>系统设置</h3>
                    <div class="form-group">
                        <label>默认思考时间（秒）</label>
                        <input type="number" class="form-control" id="defaultThinkingTime" value="30" min="10" max="300">
                    </div>
                    <div class="form-group">
                        <label>默认答题时间（分钟）</label>
                        <input type="number" class="form-control" id="defaultAnsweringTime" value="4" min="1" max="30">
                    </div>
                    <button class="btn btn-primary" onclick="saveSystemSettings()">
                        <i class="fas fa-save"></i> 保存设置
                    </button>
                    
                    <h4 style="margin-top: 30px;">数据管理</h4>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-success" onclick="exportAllData()">
                            <i class="fas fa-download"></i> 导出所有数据
                        </button>
                        <button class="btn btn-warning" onclick="importData()">
                            <i class="fas fa-upload"></i> 导入数据
                        </button>
                        <button class="btn btn-danger" onclick="clearAllData()">
                            <i class="fas fa-trash"></i> 清空所有数据
                        </button>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 30px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('settingsModal')">
                    <i class="fas fa-times"></i> 关闭
                </button>
            </div>
        </div>
    </div>

    <!-- Analysis Modal -->
    <div class="modal" id="analysisModal">
        <div class="modal-content large">
            <h3><i class="fas fa-chart-line"></i> 数据分析报告</h3>
            <div id="analysisContent"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                <button class="btn btn-primary" onclick="exportAnalysisReport()">
                    <i class="fas fa-download"></i> 导出报告
                </button>
                <button class="btn btn-secondary" onclick="closeModal('analysisModal')">
                    <i class="fas fa-times"></i> 关闭
                </button>
            </div>
        </div>
    </div>

    <!-- Student Growth Chart Modal -->
    <div class="modal" id="growthChartModal">
        <div class="modal-content large">
            <h3><i class="fas fa-chart-area"></i> 学员成长图表</h3>
            <div class="growth-chart">
                <div class="chart-container">
                    <canvas id="growthChart"></canvas>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('growthChartModal')">
                    <i class="fas fa-times"></i> 关闭
                </button>
            </div>
        </div>
    </div>

    <!-- Add Question Modal -->
    <div class="modal" id="addQuestionModal">
        <div class="modal-content">
            <h3><i class="fas fa-plus"></i> 新增题目</h3>
            <form id="addQuestionForm">
                <div class="form-group">
                    <label>省份</label>
                    <input type="text" class="form-control" id="newQuestionProvince" required>
                </div>
                <div class="form-group">
                    <label>城市</label>
                    <input type="text" class="form-control" id="newQuestionCity" required>
                </div>
                <div class="form-group">
                    <label>年份</label>
                    <input type="number" class="form-control" id="newQuestionYear" required>
                </div>
                <div class="form-group">
                    <label>医院/单位</label>
                    <input type="text" class="form-control" id="newQuestionHospital" required>
                </div>
                <div class="form-group">
                    <label>知识点分类</label>
                    <input type="text" class="form-control" id="newQuestionCategory" required>
                </div>
                <div class="form-group">
                    <label>题目</label>
                    <textarea class="form-control" id="newQuestionText" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label>答题要点</label>
                    <textarea class="form-control" id="newQuestionKeyPoints" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label>参考解析</label>
                    <textarea class="form-control" id="newQuestionAnalysis" rows="4" required></textarea>
                </div>
            </form>
            
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('addQuestionModal')">
                    <i class="fas fa-times"></i> 取消
                </button>
                <button class="btn btn-primary" onclick="saveNewQuestion()">
                    <i class="fas fa-save"></i> 保存题目
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Question Modal -->
    <div class="modal" id="editQuestionModal">
        <div class="modal-content">
            <h3><i class="fas fa-edit"></i> 编辑题目</h3>
            <form id="editQuestionForm">
                <div class="form-group">
                    <label>省份</label>
                    <input type="text" class="form-control" id="editQuestionProvince" required>
                </div>
                <div class="form-group">
                    <label>城市</label>
                    <input type="text" class="form-control" id="editQuestionCity" required>
                </div>
                <div class="form-group">
                    <label>年份</label>
                    <input type="number" class="form-control" id="editQuestionYear" required>
                </div>
                <div class="form-group">
                    <label>医院/单位</label>
                    <input type="text" class="form-control" id="editQuestionHospital" required>
                </div>
                <div class="form-group">
                    <label>知识点分类</label>
                    <input type="text" class="form-control" id="editQuestionCategory" required>
                </div>
                <div class="form-group">
                    <label>题目</label>
                    <textarea class="form-control" id="editQuestionText" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label>答题要点</label>
                    <textarea class="form-control" id="editQuestionKeyPoints" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label>参考解析</label>
                    <textarea class="form-control" id="editQuestionAnalysis" rows="4" required></textarea>
                </div>
            </form>
            
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('editQuestionModal')">
                    <i class="fas fa-times"></i> 取消
                </button>
                <button class="btn btn-primary" onclick="saveEditedQuestion()">
                    <i class="fas fa-save"></i> 保存修改
                </button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let questions = [];
        let students = [];
        let currentQuestionSet = [];
        let currentQuestionIndex = 0;
        let currentStudent = null;
        let timer = null;
        let startTime = null;
        let isTimerRunning = false;
        let timerPhase = 'waiting';
        let sessionData = [];
        let currentSessionTimes = {
            thinkingTime: 0,
            answeringTime: 0,
            thinkingStartTime: null,
            answeringStartTime: null
        };
        
        // 更新计时器状态显示
        function updateTimerStatus(phase) {
            const phaseElement = document.getElementById('currentPhase');
            if (phaseElement) {
                switch(phase) {
                    case 'thinking':
                        phaseElement.textContent = '思考中...';
                        break;
                    case 'answering':
                        phaseElement.textContent = '答题中...';
                        break;
                    case 'finished':
                        phaseElement.textContent = '已完成';
                        break;
                    default:
                        phaseElement.textContent = '等待开始';
                }
            }
            
            // 同步更新聚焦模式中的状态显示
            if (isFocusMode) {
                const focusPhase = document.querySelector('#focusTimer .timer-status #currentPhase');
                if (focusPhase) {
                    focusPhase.textContent = phaseElement.textContent;
                }
            }
        }
        let currentEvaluation = {
            fluency: null,
            depth: null,
            completeness: null,
            accuracy: null,
            logic: null,
            expression: null,
            adaptability: null,
            overall: null
        };
        let isStudentListExpanded = false;
        let isGridView = true;
        let editingQuestionIndex = -1;
        let questionMode = 'single'; // single, double, triple, quad, penta
        let questionCount = 1;
        let isFocusMode = false;
        let answeredQuestionCards = []; // 存储答题完成后的卡片信息

        // 筛选器状态
        let selectedCategories = new Set();
        let selectedProvinces = new Set();
        let selectedYears = new Set();
        let selectedHospitals = new Set();

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadSampleData();
            updateAllStatistics();
            setupFileUploads();
            loadFromLocalStorage();
            resetTimerDisplay();
            setupEvaluationHandlers();
            setupQuestionModeSelector();
            loadSystemSettings();
            setupAnalysisIndicators();
            initializeModernFilter();
            
            document.querySelectorAll('.mode-option').forEach(btn => {
                btn.onclick = function(e) {
                    document.querySelectorAll('.mode-option').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    questionCount = parseInt(this.dataset.mode);
                }
            });
            
            document.querySelector('.btn-draw-question').onclick = function() {
                // 检查是否已选择学员
                if (!currentStudent) {
                    alert('请先随机抽选学员！');
                    return;
                }
                drawRandomQuestion(questionCount);
            }
        });

        // 现代化筛选器功能
        function initializeModernFilter() {
            updateModernFilterOptions();
            updateFilterStats();
        }

        function toggleModernFilter() {
            const toggleBtn = document.getElementById('modernFilterToggle');
            const content = document.getElementById('modernFilterContent');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                toggleBtn.classList.remove('active');
            } else {
                content.classList.add('show');
                toggleBtn.classList.add('active');
            }
        }

        function updateModernFilterOptions() {
            updateCategoryFilterOptions();
            updateProvinceFilterOptions();
            updateYearFilterOptions();
            updateHospitalFilterOptions();
        }

        function updateCategoryFilterOptions() {
            const categories = [...new Set(questions.map(q => q.category).filter(Boolean))];
            const container = document.getElementById('categoryFilterOptions');
            container.innerHTML = categories.map(cat => `
                <div class="filter-option" onclick="toggleCategorySelection('${cat}')">
                    <input type="checkbox" ${selectedCategories.has(cat) ? 'checked' : ''} onchange="event.stopPropagation()">
                    <span>${cat}</span>
                </div>
            `).join('');
        }

        function updateProvinceFilterOptions() {
            const provinces = [...new Set(questions.map(q => q.province).filter(Boolean))];
            const container = document.getElementById('provinceFilterOptions');
            container.innerHTML = provinces.map(prov => `
                <div class="filter-option" onclick="toggleProvinceSelection('${prov}')">
                    <input type="checkbox" ${selectedProvinces.has(prov) ? 'checked' : ''} onchange="event.stopPropagation()">
                    <span>${prov}</span>
                </div>
            `).join('');
        }

        function updateYearFilterOptions() {
            const years = [...new Set(questions.map(q => q.year).filter(Boolean))].sort((a, b) => b - a);
            const container = document.getElementById('yearFilterOptions');
            container.innerHTML = years.map(year => `
                <div class="filter-option" onclick="toggleYearSelection('${year}')">
                    <input type="checkbox" ${selectedYears.has(year) ? 'checked' : ''} onchange="event.stopPropagation()">
                    <span>${year}</span>
                </div>
            `).join('');
        }

        function updateHospitalFilterOptions() {
            const hospitals = [...new Set(questions.map(q => q.hospital).filter(Boolean))];
            const container = document.getElementById('hospitalFilterOptions');
            container.innerHTML = hospitals.map(hosp => `
                <div class="filter-option" onclick="toggleHospitalSelection('${hosp}')">
                    <input type="checkbox" ${selectedHospitals.has(hosp) ? 'checked' : ''} onchange="event.stopPropagation()">
                    <span>${hosp}</span>
                </div>
            `).join('');
        }

        function toggleCategorySelection(category) {
            if (selectedCategories.has(category)) {
                selectedCategories.delete(category);
            } else {
                selectedCategories.add(category);
            }
            updateModernFilterOptions();
            updateFilterStats();
            filterQuestions();
        }

        function toggleProvinceSelection(province) {
            if (selectedProvinces.has(province)) {
                selectedProvinces.delete(province);
            } else {
                selectedProvinces.add(province);
            }
            updateModernFilterOptions();
            updateFilterStats();
            filterQuestions();
        }

        function toggleYearSelection(year) {
            if (selectedYears.has(year)) {
                selectedYears.delete(year);
            } else {
                selectedYears.add(year);
            }
            updateModernFilterOptions();
            updateFilterStats();
            filterQuestions();
        }

        function toggleHospitalSelection(hospital) {
            if (selectedHospitals.has(hospital)) {
                selectedHospitals.delete(hospital);
            } else {
                selectedHospitals.add(hospital);
            }
            updateModernFilterOptions();
            updateFilterStats();
            filterQuestions();
        }

        function selectAllCategories() {
            const categories = [...new Set(questions.map(q => q.category).filter(Boolean))];
            categories.forEach(cat => selectedCategories.add(cat));
            updateModernFilterOptions();
            updateFilterStats();
            filterQuestions();
        }

        function clearAllCategories() {
            selectedCategories.clear();
            updateModernFilterOptions();
            updateFilterStats();
            filterQuestions();
        }

        function selectAllProvinces() {
            const provinces = [...new Set(questions.map(q => q.province).filter(Boolean))];
            provinces.forEach(prov => selectedProvinces.add(prov));
            updateModernFilterOptions();
            updateFilterStats();
            filterQuestions();
        }

        function clearAllProvinces() {
            selectedProvinces.clear();
            updateModernFilterOptions();
            updateFilterStats();
            filterQuestions();
        }

        function selectAllYears() {
            const years = [...new Set(questions.map(q => q.year).filter(Boolean))];
            years.forEach(year => selectedYears.add(year));
            updateModernFilterOptions();
            updateFilterStats();
            filterQuestions();
        }

        function clearAllYears() {
            selectedYears.clear();
            updateModernFilterOptions();
            updateFilterStats();
            filterQuestions();
        }

        function selectAllHospitals() {
            const hospitals = [...new Set(questions.map(q => q.hospital).filter(Boolean))];
            hospitals.forEach(hosp => selectedHospitals.add(hosp));
            updateModernFilterOptions();
            updateFilterStats();
            filterQuestions();
        }

        function clearAllHospitals() {
            selectedHospitals.clear();
            updateModernFilterOptions();
            updateFilterStats();
            filterQuestions();
        }

        function updateFilterStats() {
            document.getElementById('categoryStats').textContent = `已选择 ${selectedCategories.size} 个分类`;
            document.getElementById('provinceStats').textContent = `已选择 ${selectedProvinces.size} 个省份`;
            document.getElementById('yearStats').textContent = `已选择 ${selectedYears.size} 个年份`;
            document.getElementById('hospitalStats').textContent = `已选择 ${selectedHospitals.size} 个医院类型`;
            
            const filteredCount = getFilteredQuestions().length;
            document.getElementById('filteredQuestionCount').textContent = filteredCount;
        }

        function filterQuestions() {
            updateFilterStats();
            updateAllStatistics();
        }

        // 设置分析指示器
        function setupAnalysisIndicators() {
            // 检查是否有学员被选中，显示相应的箭头提示
            updateAnalysisIndicators();
        }

        // 更新分析指示器
        function updateAnalysisIndicators() {
            const globalAnalysisBtn = document.getElementById('globalAnalysisBtn');
            const studentAnalysisBtn = document.getElementById('studentAnalysisBtn');
            
            if (currentStudent) {
                // 有学员被选中，显示学员分析按钮的箭头
                globalAnalysisBtn.classList.remove('show-arrow');
                studentAnalysisBtn.classList.add('show-arrow');
            } else {
                // 没有学员被选中，显示全局分析按钮的箭头
                globalAnalysisBtn.classList.add('show-arrow');
                studentAnalysisBtn.classList.remove('show-arrow');
            }
        }

        // 学员分析功能
        function showStudentAnalysis() {
            if (currentStudent) {
                // 如果有选中的学员，显示该学员的详细分析
                showStudentDetailAnalysis(currentStudent);
            } else {
                // 如果没有选中学员，提示先选择学员
                alert('请先点击学员列表中的学员，然后再查看分析！');
            }
        }

        // 聚焦模式功能
        function enterFocusMode() {
            if (!currentQuestionSet || currentQuestionSet.length === 0) {
                return;
            }
            
            isFocusMode = true;
            const focusMode = document.getElementById('focusMode');
            const focusQuestion = document.getElementById('focusQuestion');
            const focusTimer = document.getElementById('focusTimer');
            
            // 复制题目内容到聚焦区域
            focusQuestion.innerHTML = document.getElementById('questionContent').innerHTML;
            
            // 复制计时器内容到聚焦区域
            focusTimer.innerHTML = document.getElementById('timerSection').innerHTML;
            
            // 显示聚焦模式
            focusMode.style.display = 'flex';
            
            // 同步计时器状态
            syncTimerToFocus();
        }

        function exitFocusMode() {
            isFocusMode = false;
            document.getElementById('focusMode').style.display = 'none';
            
            // 同步聚焦区域的计时器状态回主界面
            syncTimerFromFocus();
            
            // 移除自动重置逻辑，保持答题完成状态
            // 用户可以手动点击"重新开始"按钮来重置
        }

        function syncTimerToFocus() {
            const mainTimer = document.getElementById('timerSection');
            const focusTimer = document.getElementById('focusTimer');
            
            // 同步计时器显示
            const mainDisplay = mainTimer.querySelector('#timerDisplay');
            const focusDisplay = focusTimer.querySelector('#timerDisplay');
            if (mainDisplay && focusDisplay) {
                focusDisplay.textContent = mainDisplay.textContent;
            }
            
            // 同步按钮状态
            const mainButtons = mainTimer.querySelectorAll('.timer-btn');
            const focusButtons = focusTimer.querySelectorAll('.timer-btn');
            mainButtons.forEach((btn, index) => {
                if (focusButtons[index]) {
                    focusButtons[index].disabled = btn.disabled;
                    focusButtons[index].className = btn.className;
                }
            });
        }

        function syncTimerFromFocus() {
            // 如果需要，可以在这里同步聚焦区域的状态回主界面
            // 目前计时器状态是全局的，所以不需要特别处理
        }

        // 套题模式选择器设置
        function setupQuestionModeSelector() {
            document.querySelectorAll('.mode-option').forEach(option => {
                option.addEventListener('click', function(e) {
                    e.stopPropagation();
                    document.querySelectorAll('.mode-option').forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    questionMode = this.dataset.mode;
                });
            });
        }

        // 加载系统设置
        function loadSystemSettings() {
            const savedSettings = localStorage.getItem('interviewSystemSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                document.getElementById('defaultThinkingTime').value = settings.thinkingTime || 30;
                document.getElementById('defaultAnsweringTime').value = settings.answeringTime || 4;
            }
            
            // 应用设置到计时器
            resetTimerDisplay();
        }

        // 保存系统设置
        function saveSystemSettings() {
            const settings = {
                thinkingTime: parseInt(document.getElementById('defaultThinkingTime').value) || 30,
                answeringTime: parseInt(document.getElementById('defaultAnsweringTime').value) || 4
            };
            
            localStorage.setItem('interviewSystemSettings', JSON.stringify(settings));
            resetTimerDisplay();
            alert('设置已保存！');
        }

        // 本地存储
        function saveToLocalStorage() {
            localStorage.setItem('interviewSystemPro', JSON.stringify({
                questions,
                students,
                sessionData,
                answeredQuestionCards
            }));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('interviewSystemPro');
            if (saved) {
                const data = JSON.parse(saved);
                questions = data.questions || [];
                students = data.students || [];
                sessionData = data.sessionData || [];
                answeredQuestionCards = data.answeredQuestionCards || [];
                updateModernFilterOptions();
                updateAllStatistics();
                updateStudentList();
                updateQuestionList();
                renderAnsweredQuestionCards();
            }
        }

        // 加载示例数据
        function loadSampleData() {
            if (questions.length === 0) {
                questions = [
                    {
                        province: '内蒙古',
                        city: '通辽',
                        year: '2025',
                        hospital: '事业单位',
                        category: '结构化-综合分析-现象类',
                        question: '露营作为一种贴近自然的休闲方式，正逐渐成为都市人周末度假的新宠。然而，有些人在露营地点随意丢弃垃圾、乱砍乱伐树木、破坏植被，甚至在禁止露天燃火的地区生火做饭。请谈谈你对这种现象的看法。',
                        keyPoints: '1. 露营的积极意义：提供了贴近自然的休闲方式，满足都市人的放松需求\\n2. 环境破坏行为的危害：随意丢弃垃圾、破坏植被等行为对生态环境造成长期损害\\n3. 加强环保教育和监管：需要提高公众环保意识，加强相关部门监管',
                        analysis: '露营作为一种休闲方式，应遵循环保原则，保护自然环境。随意丢弃垃圾、破坏植被等行为不仅影响环境美观，还会对生态系统造成长期损害。我们应该倡导"无痕露营"理念，通过教育引导和制度约束，让每个人都成为自然环境的守护者。'
                    },
                    {
                        province: '湖北',
                        city: '咸宁',
                        year: '2025',
                        hospital: '通山县人民医院',
                        category: '结构化-综合分析-观点类',
                        question: '习总书记说："人民健康是社会文明进步的基础，是民族昌盛和国家富强的重要标志，也是广大人民群众的共同追求。"对此你如何理解？',
                        keyPoints: '1. 人民健康的重要性：健康是人民幸福生活的前提和基础\\n2. 医疗服务的提升：需要不断提高医疗服务质量和水平\\n3. 健康公平的实现：确保每个人都能享受到优质的医疗服务',
                        analysis: '人民健康不仅是社会文明进步的基础，也是民族昌盛和国家富强的重要标志。作为医疗工作者，我们应致力于提高医疗服务质量，保障人民健康，推动健康中国建设。'
                    },
                    {
                        province: '辽宁',
                        city: '沈阳',
                        year: '2025',
                        hospital: '联考',
                        category: '结构化-组织管理',
                        question: '为进一步提高居民的健康意识和提高全民健康水平，你院准备组织夜市义诊活动，该活动由你来负责，你会如何开展？',
                        keyPoints: '1. 确定活动时间和地点：选择人流量大的夜市区域\\n2. 组织医疗团队：包括全科医生、护士和志愿者\\n3. 准备宣传材料：制作健康手册、海报等宣传资料\\n4. 提供免费体检和健康咨询：重点宣传常见病预防知识',
                        analysis: '组织夜市义诊活动需要周密策划，包括确定目标、制定计划、协调资源等，确保活动顺利进行并达到预期效果。通过这样的活动，可以有效提升公众健康意识。'
                    },
                    {
                        province: '广东',
                        city: '深圳',
                        year: '2024',
                        hospital: '市人民医院',
                        category: '结构化-人际关系',
                        question: '你是新入职的护士，在工作中发现同事小王经常迟到早退，影响了科室的工作效率，你会怎么处理？',
                        keyPoints: '1. 了解情况：私下与小王沟通，了解迟到早退的原因\\n2. 提供帮助：如果是个人困难，主动提供力所能及的帮助\\n3. 规范管理：必要时向护士长反映情况，维护科室秩序',
                        analysis: '处理同事关系问题需要平衡个人情感和工作原则。既要体现人文关怀，也要维护工作纪律，通过合理的沟通和协调来解决问题。'
                    },
                    {
                        province: '江苏',
                        city: '南京',
                        year: '2024',
                        hospital: '省中医院',
                        category: '结构化-应急应变',
                        question: '在急诊科工作时，突然来了多名车祸伤员，人手不够，家属情绪激动，你作为当班护士该如何处理？',
                        keyPoints: '1. 快速评估：迅速评估伤员伤情，按轻重缓急分类处理\\n2. 调配资源：立即联系相关科室支援，合理分配医护人员\\n3. 安抚家属：耐心解释救治流程，安排专人负责家属沟通',
                        analysis: '应急情况下需要保持冷静，快速做出正确判断。优先保证患者安全，同时做好家属工作，体现医护人员的专业素养和人文关怀。'
                    }
                ];
            }
            
            if (students.length === 0) {
                students = [
                    { name: '孙思宇', id: '001', count: 0, totalThinkingTime: 0, totalAnsweringTime: 0, sessions: [], evaluations: [], growthScore: 0 },
                    { name: '赵凌艺', id: '002', count: 0, totalThinkingTime: 0, totalAnsweringTime: 0, sessions: [], evaluations: [], growthScore: 0 },
                    { name: '秦瑞', id: '003', count: 0, totalThinkingTime: 0, totalAnsweringTime: 0, sessions: [], evaluations: [], growthScore: 0 },
                    { name: '李明', id: '004', count: 0, totalThinkingTime: 0, totalAnsweringTime: 0, sessions: [], evaluations: [], growthScore: 0 },
                    { name: '王芳', id: '005', count: 0, totalThinkingTime: 0, totalAnsweringTime: 0, sessions: [], evaluations: [], growthScore: 0 },
                    { name: '张伟', id: '006', count: 0, totalThinkingTime: 0, totalAnsweringTime: 0, sessions: [], evaluations: [], growthScore: 0 },
                    { name: '刘洋', id: '007', count: 0, totalThinkingTime: 0, totalAnsweringTime: 0, sessions: [], evaluations: [], growthScore: 0 },
                    { name: '陈静', id: '008', count: 0, totalThinkingTime: 0, totalAnsweringTime: 0, sessions: [], evaluations: [], growthScore: 0 },
                    { name: '杨帆', id: '009', count: 0, totalThinkingTime: 0, totalAnsweringTime: 0, sessions: [], evaluations: [], growthScore: 0 },
                    { name: '黄丽', id: '010', count: 0, totalThinkingTime: 0, totalAnsweringTime: 0, sessions: [], evaluations: [], growthScore: 0 },
                    { name: '周强', id: '011', count: 0, totalThinkingTime: 0, totalAnsweringTime: 0, sessions: [], evaluations: [], growthScore: 0 },
                    { name: '吴敏', id: '012', count: 0, totalThinkingTime: 0, totalAnsweringTime: 0, sessions: [], evaluations: [], growthScore: 0 },
                    { name: '郑浩', id: '013', count: 0, totalThinkingTime: 0, totalAnsweringTime: 0, sessions: [], evaluations: [], growthScore: 0 },
                    { name: '朱琳', id: '014', count: 0, totalThinkingTime: 0, totalAnsweringTime: 0, sessions: [], evaluations: [], growthScore: 0 },
                    { name: '马超', id: '015', count: 0, totalThinkingTime: 0, totalAnsweringTime: 0, sessions: [], evaluations: [], growthScore: 0 },
                    { name: '许娜', id: '016', count: 0, totalThinkingTime: 0, totalAnsweringTime: 0, sessions: [], evaluations: [], growthScore: 0 },
                    { name: '胡斌', id: '017', count: 0, totalThinkingTime: 0, totalAnsweringTime: 0, sessions: [], evaluations: [], growthScore: 0 },
                    { name: '林雪', id: '018', count: 0, totalThinkingTime: 0, totalAnsweringTime: 0, sessions: [], evaluations: [], growthScore: 0 },
                    { name: '高峰', id: '019', count: 0, totalThinkingTime: 0, totalAnsweringTime: 0, sessions: [], evaluations: [], growthScore: 0 },
                    { name: '梁颖', id: '020', count: 0, totalThinkingTime: 0, totalAnsweringTime: 0, sessions: [], evaluations: [], growthScore: 0 }
                ];
            }
            
            updateModernFilterOptions();
            updateAllStatistics();
            updateStudentList();
            updateQuestionList();
        }

        // 获取筛选后的题目
        function getFilteredQuestions() {
            return questions.filter(q => {
                return (selectedCategories.size === 0 || selectedCategories.has(q.category)) &&
                       (selectedProvinces.size === 0 || selectedProvinces.has(q.province)) &&
                       (selectedYears.size === 0 || selectedYears.has(q.year)) &&
                       (selectedHospitals.size === 0 || selectedHospitals.has(q.hospital));
            });
        }

        // 套题抽取逻辑
        function drawRandomQuestion(count) {
            // 检查是否已选择学员
            if (!currentStudent) {
                alert('请先随机抽选学员！');
                return;
            }
            
            const filteredQuestions = getFilteredQuestions();
            if (filteredQuestions.length === 0) {
                alert('当前筛选条件下没有题目！');
                return;
            }
            if (filteredQuestions.length < count) {
                alert(`当前筛选条件下题目不足${count}道！`);
                return;
            }
            currentQuestionSet = [];
            const usedIndices = new Set();
            for (let i = 0; i < count; i++) {
                let randomIndex;
                do {
                    randomIndex = Math.floor(Math.random() * filteredQuestions.length);
                } while (usedIndices.has(randomIndex));
                usedIndices.add(randomIndex);
                currentQuestionSet.push(filteredQuestions[randomIndex]);
            }
            currentQuestionIndex = 0;
            showQuestionRoulette();
        }

        // 显示抽题动画
        function showQuestionRoulette() {
            const questionRoulette = document.getElementById('questionRoulette');
            const cardStack = document.getElementById('cardStack');
            const questionCountdown = document.getElementById('questionCountdown');
            const questionCardTitle = document.querySelector('.question-card-title');
            
            // 更新标题
            const modeText = currentQuestionSet.length + '题套题';
            questionCardTitle.innerHTML = `<i class="fas fa-magic"></i> 正在抽取${modeText}...`;
            
            questionRoulette.style.display = 'flex';
            questionCountdown.textContent = '正在洗牌...';
            
            // 动态生成卡片
            cardStack.innerHTML = '';
            for (let i = 0; i < currentQuestionSet.length; i++) {
                const card = document.createElement('div');
                card.className = 'card-item';
                card.textContent = `题目 ${i + 1}`;
                card.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)'; // 与btn-draw-question一致
                cardStack.appendChild(card);
            }
            
            // 洗牌动画
            setTimeout(() => {
                cardStack.querySelectorAll('.card-item').forEach(card => {
                    card.classList.add('shuffling');
                });
                questionCountdown.textContent = '正在抽取题目...';
            }, 500);
            
            // 选择题目
            setTimeout(() => {
                cardStack.querySelectorAll('.card-item').forEach(card => {
                    card.classList.remove('shuffling');
                });
                
                // 随机选择一张卡片
                const selectedIndex = Math.floor(Math.random() * cardStack.children.length);
                const selectedCard = cardStack.children[selectedIndex];
                
                // 显示选中的题目信息
                const firstQuestion = currentQuestionSet[0];
                const shortQuestion = firstQuestion.question.length > 30 ? 
                    firstQuestion.question.substring(0, 30) + '...' : firstQuestion.question;
                selectedCard.innerHTML = `
                    <div style="text-align: center; padding: 10px;">
                        <div style="font-size: 0.8rem; margin-bottom: 8px; opacity: 0.8;">
                            ${currentQuestionSet.length}题套题
                        </div>
                        <div style="font-size: 0.9rem; line-height: 1.3;">
                            ${shortQuestion}
                        </div>
                    </div>
                `;
                
                selectedCard.classList.add('selected');
                questionCountdown.textContent = '抽取完成！';
                
                // 2秒后关闭动画并显示完整题目
                setTimeout(() => {
                    questionRoulette.style.display = 'none';
                    displayQuestionSet();
                    
                    // 隐藏答案
                    hideAnswerKey();
                    
                    // 重置计时器
                    resetTimer();
                    
                    // 进入聚焦模式
                    setTimeout(() => {
                        enterFocusMode();
                    }, 500);
                    
                    // 记录抽题
                    sessionData.push({
                        type: 'questionSet',
                        questions: currentQuestionSet.map(q => q.question),
                        categories: currentQuestionSet.map(q => q.category),
                        timestamp: new Date(),
                        student: currentStudent ? currentStudent.name : null,
                        mode: questionMode
                    });

                    updateAllStatistics();
                    saveToLocalStorage();
                }, 2000);
            }, 1500);
        }

        // 显示套题
        function displayQuestionSet() {
            const questionContent = document.getElementById('questionContent');
            
            if (currentQuestionSet.length === 1) {
                // 单题模式
                displaySingleQuestion(currentQuestionSet[0]);
            } else {
                // 套题模式
                const currentQuestion = currentQuestionSet[currentQuestionIndex];
                
                questionContent.innerHTML = `
                    <div class="question-set-header">
                        <div class="set-info">
                            <i class="fas fa-layer-group"></i>
                            <span>第 ${currentQuestionIndex + 1} 题 / 共 ${currentQuestionSet.length} 题</span>
                        </div>
                        <div class="question-nav">
                            ${currentQuestionSet.map((_, index) => `
                                <div class="nav-dot ${index === currentQuestionIndex ? 'active' : ''} ${index < currentQuestionIndex ? 'completed' : ''}" 
                                     onclick="switchToQuestion(${index})"></div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="question-meta">
                        <span class="meta-tag"><i class="fas fa-map-marker-alt"></i> ${currentQuestion.province} ${currentQuestion.city}</span>
                        <span class="meta-tag"><i class="fas fa-hospital"></i> ${currentQuestion.hospital}</span>
                        <span class="meta-tag"><i class="fas fa-calendar"></i> ${currentQuestion.year}</span>
                        <span class="meta-tag"><i class="fas fa-tag"></i> ${currentQuestion.category}</span>
                    </div>
                    <div class="question-text">${currentQuestion.question}</div>
                    ${currentQuestionSet.length > 1 ? `
                        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                            <button class="btn btn-secondary" onclick="previousQuestion()" ${currentQuestionIndex === 0 ? 'disabled' : ''}>
                                <i class="fas fa-chevron-left"></i> 上一题
                            </button>
                            <button class="btn btn-primary" onclick="nextQuestion()" ${currentQuestionIndex === currentQuestionSet.length - 1 ? 'disabled' : ''}>
                                下一题 <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    ` : ''}
                `;
                // 优化完成/下一题按钮文本
                const finishBtnText = document.getElementById('finishBtnText');
                if (finishBtnText) {
                    if (currentQuestionSet.length > 1) {
                        finishBtnText.textContent = currentQuestionIndex === currentQuestionSet.length - 1 ? '完成' : '下一题';
                    } else {
                        finishBtnText.textContent = '完成';
                    }
                }
            }
            
            // 如果在聚焦模式，同步更新聚焦区域
            if (isFocusMode) {
                document.getElementById('focusQuestion').innerHTML = questionContent.innerHTML;
            }
        }

        // 显示单题
        function displaySingleQuestion(question) {
            const questionContent = document.getElementById('questionContent');
            
            questionContent.innerHTML = `
                <div class="question-meta">
                    <span class="meta-tag"><i class="fas fa-map-marker-alt"></i> ${question.province} ${question.city}</span>
                    <span class="meta-tag"><i class="fas fa-hospital"></i> ${question.hospital}</span>
                    <span class="meta-tag"><i class="fas fa-calendar"></i> ${question.year}</span>
                    <span class="meta-tag"><i class="fas fa-tag"></i> ${question.category}</span>
                </div>
                <div class="question-text">${question.question}</div>
            `;
            
            // 如果在聚焦模式，同步更新聚焦区域
            if (isFocusMode) {
                document.getElementById('focusQuestion').innerHTML = questionContent.innerHTML;
            }
        }

        // 切换到指定题目
        function switchToQuestion(index) {
            if (index >= 0 && index < currentQuestionSet.length) {
                currentQuestionIndex = index;
                displayQuestionSet();
            }
        }

        // 上一题
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestionSet();
            }
        }

        // 下一题
        function nextQuestion() {
            if (currentQuestionIndex < currentQuestionSet.length - 1) {
                currentQuestionIndex++;
                displayQuestionSet();
            }
        }

        // 随机抽人
        function drawRandomStudent() {
            if (students.length === 0) {
                alert('请先在设置中添加学员！');
                return;
            }

            // 显示抽人轮盘
            const roulette = document.getElementById('studentRoulette');
            const rouletteName = document.getElementById('rouletteName');
            const rouletteCountdown = document.getElementById('rouletteCountdown');
            const rouletteResult = document.getElementById('rouletteResult');
            
            roulette.style.display = 'flex';
            rouletteResult.style.display = 'none';
            rouletteCountdown.textContent = '正在随机选择...';
            
            // 快速切换名字动画
            let currentIndex = 0;
            let switchCount = 0;
            const maxSwitches = 30;
            let switchSpeed = 100;
            
            const nameSwitch = setInterval(() => {
                rouletteName.textContent = students[currentIndex].name;
                currentIndex = (currentIndex + 1) % students.length;
                switchCount++;
                
                // 逐渐减慢速度
                if (switchCount > 15) {
                    switchSpeed += 20;
                    clearInterval(nameSwitch);
                    setTimeout(() => startSlowSwitch(), switchSpeed);
                }
            }, switchSpeed);
            
            function startSlowSwitch() {
                let slowSwitchCount = 0;
                const maxSlowSwitches = 10;
                let slowSpeed = 200;
                
                const slowSwitch = setInterval(() => {
                    rouletteName.textContent = students[currentIndex].name;
                    currentIndex = (currentIndex + 1) % students.length;
                    slowSwitchCount++;
                    slowSpeed += 50;
                    
                    if (slowSwitchCount >= maxSlowSwitches) {
                        clearInterval(slowSwitch);
                        selectFinalStudent();
                    }
                }, slowSpeed);
            }
            
            function selectFinalStudent() {
                // 优先选择被抽次数较少的学员
                const minCount = Math.min(...students.map(s => s.count));
                const candidates = students.filter(s => s.count === minCount);
                const selectedStudent = candidates[Math.floor(Math.random() * candidates.length)];
                
                // 显示最终结果
                rouletteName.textContent = selectedStudent.name;
                rouletteCountdown.textContent = '';
                rouletteResult.textContent = `🎉 ${selectedStudent.name} 🎉`;
                rouletteResult.style.display = 'block';
                
                // 更新选中学员
                currentStudent = selectedStudent;
                currentStudent.count++;
                
                // 记录抽人
                sessionData.push({
                    type: 'student',
                    student: currentStudent.name,
                    timestamp: new Date()
                });
                
                // 3秒后关闭轮盘
                setTimeout(() => {
                    roulette.style.display = 'none';
                    updateStudentList();
                    updateAllStatistics();
                    saveToLocalStorage();
                    
                    // 在学员列表中聚焦显示被选中的学员
                    focusSelectedStudent(selectedStudent.name);
                    
                    // 更新分析指示器
                    updateAnalysisIndicators();
                }, 3000);
            }
        }

        // 在学员列表中聚焦显示被选中的学员
        function focusSelectedStudent(studentName) {
            const studentItems = document.querySelectorAll('.student-item');
            studentItems.forEach(item => {
                const nameElement = item.querySelector('.student-name');
                if (nameElement && nameElement.textContent === studentName) {
                    item.classList.add('just-selected');
                    // 滚动到该学员
                    item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // 3秒后移除动画效果，保持聚焦状态
                    setTimeout(() => {
                        item.classList.remove('just-selected');
                        item.classList.add('focused');
                    }, 3000);
                } else {
                    item.classList.remove('selected', 'just-selected', 'focused');
                }
            });
        }

        // 学员列表展开功能
        function toggleStudentExpand() {
            const studentList = document.getElementById('studentList');
            const toggleBtn = document.getElementById('toggleStudentExpand');
            
            isStudentListExpanded = !isStudentListExpanded;
            
            if (isStudentListExpanded) {
                studentList.classList.add('expanded');
                toggleBtn.innerHTML = '<i class="fas fa-compress"></i> 收起';
            } else {
                studentList.classList.remove('expanded');
                toggleBtn.innerHTML = '<i class="fas fa-expand"></i> 展开所有';
            }
        }

        // 学员视图切换
        function toggleStudentView() {
            const studentList = document.getElementById('studentList');
            const toggleBtn = document.getElementById('toggleStudentView');
            
            isGridView = !isGridView;
            
            if (isGridView) {
                studentList.classList.remove('list-view');
                toggleBtn.innerHTML = '<i class="fas fa-list"></i> 列表视图';
            } else {
                studentList.classList.add('list-view');
                toggleBtn.innerHTML = '<i class="fas fa-th"></i> 网格视图';
            }
            
            updateStudentList();
        }

        // 清除学员选择
        function clearStudentSelection() {
            currentStudent = null;
            document.querySelectorAll('.student-item').forEach(item => {
                item.classList.remove('selected', 'just-selected', 'focused');
            });
            
            // 更新分析指示器
            updateAnalysisIndicators();
        }

        // 显示学员成长图表
        function showStudentGrowthChart() {
            if (students.length === 0) {
                alert('暂无学员数据！');
                return;
            }
            
            document.getElementById('growthChartModal').style.display = 'block';
            
            // 准备图表数据
            const chartData = students.map(student => ({
                name: student.name,
                sessions: student.sessions.length,
                avgScore: calculateStudentAvgScore(student),
                growthTrend: calculateGrowthTrend(student)
            })).sort((a, b) => b.avgScore - a.avgScore);
            
            // 创建图表
            const ctx = document.getElementById('growthChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.name),
                    datasets: [{
                        label: '练习次数',
                        data: chartData.map(d => d.sessions),
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: '平均评分',
                        data: chartData.map(d => d.avgScore),
                        type: 'line',
                        backgroundColor: 'rgba(255, 107, 107, 0.6)',
                        borderColor: 'rgba(255, 107, 107, 1)',
                        borderWidth: 2,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '练习次数'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '平均评分'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '学员练习情况与成长趋势'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        // 计算学员平均评分
        function calculateStudentAvgScore(student) {
            if (!student.evaluations || student.evaluations.length === 0) return 0;
            
            const scoreMap = { 'excellent': 5, 'good': 4, 'average': 3, 'poor': 2, 'very-poor': 1 };
            let totalScore = 0;
            let totalEvaluations = 0;
            
            student.evaluations.forEach(evaluation => {
                Object.values(evaluation).forEach(value => {
                    if (scoreMap[value]) {
                        totalScore += scoreMap[value];
                        totalEvaluations++;
                    }
                });
            });
            
            return totalEvaluations > 0 ? (totalScore / totalEvaluations).toFixed(1) : 0;
        }

        // 计算成长趋势
        function calculateGrowthTrend(student) {
            if (!student.evaluations || student.evaluations.length < 2) return 0;
            
            const firstScore = calculateEvaluationScore(student.evaluations[0]);
            const lastScore = calculateEvaluationScore(student.evaluations[student.evaluations.length - 1]);
            
            return lastScore - firstScore;
        }

        // 计算单次评估得分
        function calculateEvaluationScore(evaluation) {
            const scoreMap = { 'excellent': 5, 'good': 4, 'average': 3, 'poor': 2, 'very-poor': 1 };
            let totalScore = 0;
            let count = 0;
            
            Object.values(evaluation).forEach(value => {
                if (scoreMap[value]) {
                    totalScore += scoreMap[value];
                    count++;
                }
            });
            
            return count > 0 ? totalScore / count : 0;
        }

        // 学员管理
        function updateStudentList() {
            const listElement = document.getElementById('studentList');
            const countElement = document.getElementById('studentCount');
            
            countElement.textContent = students.length;
            
            if (students.length === 0) {
                listElement.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 20px; grid-column: 1 / -1;">
                        <i class="fas fa-user-plus" style="font-size: 1.5rem; margin-bottom: 8px; opacity: 0.3;"></i>
                        <div style="font-size: 0.8rem;">暂无学员</div>
                        <div style="font-size: 0.7rem; margin-top: 3px;">请在设置中添加学员</div>
                    </div>
                `;
                return;
            }
            
            // 按成长得分排序
            const sortedStudents = [...students].sort((a, b) => {
                const scoreA = calculateStudentAvgScore(a);
                const scoreB = calculateStudentAvgScore(b);
                return scoreB - scoreA;
            });
            
            listElement.innerHTML = sortedStudents.map(student => {
                const avgThinking = student.sessions.length > 0 ? 
                    Math.round(student.totalThinkingTime / student.sessions.length / 1000) : 0;
                const avgAnswering = student.sessions.length > 0 ? 
                    Math.round(student.totalAnsweringTime / student.sessions.length / 1000) : 0;
                const avgScore = calculateStudentAvgScore(student);
                const growthTrend = calculateGrowthTrend(student);
                
                const isSelected = currentStudent && currentStudent.name === student.name;
                
                // 计算成长进度（基于练习次数和评分）
                const maxSessions = Math.max(...students.map(s => s.sessions.length), 1);
                const progressPercent = (student.sessions.length / maxSessions) * 100;
                
                return `
                    <div class="student-item ${isSelected ? 'selected' : ''}" 
                         onclick="selectStudentForAnalysis('${student.name}')" 
                         title="点击查看${student.name}的详细答题记录">
                        <div class="student-info">
                            <div class="student-name">${student.name}</div>
                            <div class="student-stats">
                                <div>练习${student.sessions.length}次 · 评估${student.evaluations ? student.evaluations.length : 0}次</div>
                                <div>思考${avgThinking}s · 答题${avgAnswering}s</div>
                                ${avgScore > 0 ? `<div>平均评分: ${avgScore}/5.0 ${growthTrend > 0 ? '📈' : growthTrend < 0 ? '📉' : '➡️'}</div>` : ''}
                            </div>
                            <div class="student-progress">
                                <div class="progress-bar" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>
                        <div class="student-badge">${student.count}</div>
                    </div>
                `;
            }).join('');
        }

        function selectStudentForAnalysis(studentName) {
            const student = students.find(s => s.name === studentName);
            if (student) {
                // 清除之前的选择状态
                document.querySelectorAll('.student-item').forEach(item => {
                    item.classList.remove('selected', 'just-selected', 'focused');
                });
                
                currentStudent = student;
                updateStudentList();
                
                // 更新分析指示器
                updateAnalysisIndicators();
            }
        }
        
        // 显示学员详细分析
        function showStudentDetailAnalysis(student) {
            const modal = document.getElementById('studentDetailModal');
            if (!modal) {
                createStudentDetailModal();
            }
            
            const content = document.getElementById('studentDetailContent');
            
            // 计算统计数据
            const avgThinking = student.sessions.length > 0 ? 
                Math.round(student.totalThinkingTime / student.sessions.length / 1000) : 0;
            const avgAnswering = student.sessions.length > 0 ? 
                Math.round(student.totalAnsweringTime / student.sessions.length / 1000) : 0;
            const avgScore = calculateStudentAvgScore(student);
            const growthTrend = calculateGrowthTrend(student);
            
            // 生成详细内容
            let detailHTML = `
                <div style="margin-bottom: 30px;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">
                        <i class="fas fa-user"></i> ${student.name} 的学习档案
                    </h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;">${student.count}</div>
                            <div style="font-size: 0.8rem; color: #666;">被抽次数</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;">${student.sessions.length}</div>
                            <div style="font-size: 0.8rem; color: #666;">完整练习次数</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;">${avgThinking}s</div>
                            <div style="font-size: 0.8rem; color: #666;">平均思考时间</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;">${avgAnswering}s</div>
                            <div style="font-size: 0.8rem; color: #666;">平均答题时间</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;">${avgScore}/5.0</div>
                            <div style="font-size: 0.8rem; color: #666;">平均评分</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;">${growthTrend > 0 ? '📈' : growthTrend < 0 ? '📉' : '➡️'}</div>
                            <div style="font-size: 0.8rem; color: #666;">成长趋势</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h5 style="color: #667eea; margin-bottom: 15px;">
                        <i class="fas fa-history"></i> 答题记录详情
                    </h5>
            `;
            
            if (student.sessions.length === 0) {
                detailHTML += `
                    <div style="text-align: center; color: #666; padding: 20px;">
                        <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.3;"></i>
                        <div>暂无答题记录</div>
                    </div>
                `;
            } else {
                student.sessions.forEach((session, index) => {
                    const sessionDate = new Date(session.timestamp).toLocaleString('zh-CN');
                    const thinkingTime = Math.round(session.thinkingTime / 1000);
                    const answeringTime = Math.round(session.answeringTime / 1000);
                    const totalTime = thinkingTime + answeringTime;
                    
                    // 查找对应的评估
                    const evaluation = student.evaluations ? 
                        student.evaluations.find(e => Math.abs(new Date(e.timestamp) - new Date(session.timestamp)) < 60000) : null;
                    
                    detailHTML += `
                        <div style="background: white; border: 1px solid #e9ecef; border-radius: 10px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h6 style="color: #333; margin: 0;">
                                    <i class="fas fa-clock"></i> 第${index + 1}次练习
                                </h6>
                                <span style="color: #666; font-size: 0.9rem;">${sessionDate}</span>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #667eea;">题目内容：</strong>
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 5px; line-height: 1.5;">
                                    ${Array.isArray(session.questions) ? session.questions.join('<br><br>') : session.questions || '未记录'}
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px;">
                                <div style="text-align: center; padding: 10px; background: #e3f2fd; border-radius: 8px;">
                                    <div style="font-weight: bold; color: #1976d2;">${thinkingTime}s</div>
                                    <div style="font-size: 0.8rem; color: #666;">思考时间</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #fff3e0; border-radius: 8px;">
                                    <div style="font-weight: bold; color: #f57c00;">${answeringTime}s</div>
                                    <div style="font-size: 0.8rem; color: #666;">答题时间</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #f3e5f5; border-radius: 8px;">
                                    <div style="font-weight: bold; color: #7b1fa2;">${totalTime}s</div>
                                    <div style="font-size: 0.8rem; color: #666;">总用时</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #e8f5e8; border-radius: 8px;">
                                    <div style="font-weight: bold; color: #388e3c;">${Array.isArray(session.categories) ? session.categories.join(', ') : session.categories || '未分类'}</div>
                                    <div style="font-size: 0.8rem; color: #666;">知识点</div>
                                </div>
                            </div>
                            
                            ${evaluation ? `
                                <div style="border-top: 1px solid #e9ecef; padding-top: 15px;">
                                    <strong style="color: #667eea;">评估结果：</strong>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; margin-top: 10px;">
                                        <div style="text-align: center; padding: 8px; background: #f0f8ff; border-radius: 6px;">
                                            <div style="font-size: 0.7rem; color: #666;">流畅度</div>
                                            <div style="font-weight: bold; color: #667eea;">${evaluation.fluency || 'N/A'}</div>
                                        </div>
                                        <div style="text-align: center; padding: 8px; background: #f0f8ff; border-radius: 6px;">
                                            <div style="font-size: 0.7rem; color: #666;">深度</div>
                                            <div style="font-weight: bold; color: #667eea;">${evaluation.depth || 'N/A'}</div>
                                        </div>
                                        <div style="text-align: center; padding: 8px; background: #f0f8ff; border-radius: 6px;">
                                            <div style="font-size: 0.7rem; color: #666;">完整性</div>
                                            <div style="font-weight: bold; color: #667eea;">${evaluation.completeness || 'N/A'}</div>
                                        </div>
                                        <div style="text-align: center; padding: 8px; background: #f0f8ff; border-radius: 6px;">
                                            <div style="font-size: 0.7rem; color: #666;">准确性</div>
                                            <div style="font-weight: bold; color: #667eea;">${evaluation.accuracy || 'N/A'}</div>
                                        </div>
                                        <div style="text-align: center; padding: 8px; background: #f0f8ff; border-radius: 6px;">
                                            <div style="font-size: 0.7rem; color: #666;">逻辑性</div>
                                            <div style="font-weight: bold; color: #667eea;">${evaluation.logic || 'N/A'}</div>
                                        </div>
                                        <div style="text-align: center; padding: 8px; background: #f0f8ff; border-radius: 6px;">
                                            <div style="font-size: 0.7rem; color: #666;">表达力</div>
                                            <div style="font-weight: bold; color: #667eea;">${evaluation.expression || 'N/A'}</div>
                                        </div>
                                    </div>
                                    ${evaluation.comments ? `
                                        <div style="margin-top: 10px;">
                                            <strong style="color: #667eea;">评语：</strong>
                                            <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 5px; font-style: italic;">
                                                ${evaluation.comments}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : `
                                <div style="border-top: 1px solid #e9ecef; padding-top: 15px; text-align: center; color: #999;">
                                    <i class="fas fa-info-circle"></i> 本次练习暂无评估记录
                                </div>
                            `}
                        </div>
                    `;
                });
            }
            
            detailHTML += '</div>';
            
            content.innerHTML = detailHTML;
            document.getElementById('studentDetailModal').style.display = 'block';
        }
        
        // 创建学员详细分析模态框
        function createStudentDetailModal() {
            const modalHTML = `
                <div class="modal" id="studentDetailModal">
                    <div class="modal-content large">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3><i class="fas fa-user-chart"></i> 学员详细分析</h3>
                            <button class="btn btn-secondary" onclick="closeModal('studentDetailModal')" style="padding: 8px 12px;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="studentDetailContent"></div>
                        <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                            <button class="btn btn-primary" onclick="exportStudentDetail()">
                                <i class="fas fa-download"></i> 导出详情
                            </button>
                            <button class="btn btn-secondary" onclick="closeModal('studentDetailModal')">
                                <i class="fas fa-times"></i> 关闭
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        // 导出学员详情
        function exportStudentDetail() {
            if (!currentStudent) {
                alert('请先选择学员！');
                return;
            }
            
            const data = {
                学员姓名: currentStudent.name,
                学号: currentStudent.id,
                被抽次数: currentStudent.count,
                完整练习次数: currentStudent.sessions.length,
                总思考时间: Math.round(currentStudent.totalThinkingTime / 1000),
                总答题时间: Math.round(currentStudent.totalAnsweringTime / 1000),
                平均思考时间: currentStudent.sessions.length > 0 ? Math.round(currentStudent.totalThinkingTime / currentStudent.sessions.length / 1000) : 0,
                平均答题时间: currentStudent.sessions.length > 0 ? Math.round(currentStudent.totalAnsweringTime / currentStudent.sessions.length / 1000) : 0,
                评估次数: currentStudent.evaluations ? currentStudent.evaluations.length : 0,
                平均评分: calculateStudentAvgScore(currentStudent),
                成长趋势: calculateGrowthTrend(currentStudent),
                详细记录: currentStudent.sessions.map((session, index) => ({
                    练习序号: index + 1,
                    练习时间: new Date(session.timestamp).toLocaleString('zh-CN'),
                    题目内容: Array.isArray(session.questions) ? session.questions.join('; ') : session.questions,
                    知识点: Array.isArray(session.categories) ? session.categories.join(', ') : session.categories,
                    思考时间: Math.round(session.thinkingTime / 1000) + 's',
                    答题时间: Math.round(session.answeringTime / 1000) + 's',
                    总用时: Math.round((session.thinkingTime + session.answeringTime) / 1000) + 's'
                }))
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${currentStudent.name}_详细分析_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // 显示答案
        function showAnswerKey() {
            if (!currentQuestionSet || currentQuestionSet.length === 0) {
                alert('请先抽取题目！');
                return;
            }

            const answerSection = document.getElementById('answerSection');
            const answerPoints = document.getElementById('answerPoints');
            const answerAnalysis = document.getElementById('answerAnalysis');
            
            if (currentQuestionSet.length === 1) {
                // 单题模式
                const question = currentQuestionSet[0];
                showSingleQuestionAnswer(question, answerPoints, answerAnalysis);
            } else {
                // 套题模式 - 显示所有题目的答案
                let allPoints = '';
                let allAnalysis = '';
                
                currentQuestionSet.forEach((question, index) => {
                    const formattedPoints = question.keyPoints
                        .replace(/\\n/g, '\n')
                        .split('\n')
                        .filter(point => point.trim())
                        .map(point => `<p style="margin-bottom: 8px;">${point.trim()}</p>`)
                        .join('');
                    
                    const formattedAnalysis = question.analysis
                        .replace(/\\n/g, '\n')
                        .split('\n')
                        .filter(line => line.trim())
                        .map(line => `<p style="margin-bottom: 8px;">${line.trim()}</p>`)
                        .join('');
                    
                    allPoints += `
                        <div style="margin-bottom: 25px; padding: 15px; border-left: 4px solid #667eea; background: #f8f9fa;">
                            <h5 style="color: #667eea; margin-bottom: 10px;">第${index + 1}题答题要点：</h5>
                            ${formattedPoints}
                        </div>
                    `;
                    
                    allAnalysis += `
                        <div style="margin-bottom: 20px;">
                            <h5 style="margin-bottom: 10px;">第${index + 1}题解析：</h5>
                            ${formattedAnalysis}
                        </div>
                    `;
                });
                
                answerPoints.innerHTML = allPoints;
                answerAnalysis.innerHTML = allAnalysis;
            }
            
            answerSection.classList.add('show');
            
            // 如果有学员被选中且计时器在运行，自动完成答题
            if (currentStudent && (timerPhase === 'thinking' || timerPhase === 'answering')) {
                finishAnswering();
            }
        }

        // 显示单题答案
        function showSingleQuestionAnswer(question, answerPoints, answerAnalysis) {
            // 处理答题要点，将\\n转换为换行
            const formattedPoints = question.keyPoints
                .replace(/\\n/g, '\n')
                .split('\n')
                .filter(point => point.trim())
                .map(point => `<p style="margin-bottom: 10px;">${point.trim()}</p>`)
                .join('');
            
            answerPoints.innerHTML = formattedPoints;
            
            // 处理参考解析，将\\n转换为换行
            const formattedAnalysis = question.analysis
                .replace(/\\n/g, '\n')
                .split('\n')
                .filter(line => line.trim())
                .map(line => `<p style="margin-bottom: 10px;">${line.trim()}</p>`)
                .join('');
            
            answerAnalysis.innerHTML = formattedAnalysis;
        }

        function hideAnswerKey() {
            document.getElementById('answerSection').classList.remove('show');
        }

        // 答题卡片散落功能
        function createAnsweredQuestionCard(sessionData) {
            const cardsArea = document.getElementById('questionCardsArea');
            
            // 创建卡片
            const card = document.createElement('div');
            card.className = 'answered-question-card';
            
            // 随机位置
            const maxX = cardsArea.clientWidth - 120;
            const maxY = cardsArea.clientHeight - 80;
            const x = Math.random() * Math.max(0, maxX);
            const y = Math.random() * Math.max(0, maxY);
            
            card.style.left = x + 'px';
            card.style.top = y + 'px';
            
            // 计算表现评分
            const avgScore = sessionData.evaluation ? calculateEvaluationScore(sessionData.evaluation) : 0;
            const scoreText = avgScore > 0 ? avgScore.toFixed(1) : '--';
            
            // 卡片内容
            const shortQuestion = sessionData.questions[0].length > 20 ? 
                sessionData.questions[0].substring(0, 20) + '...' : sessionData.questions[0];
            
            card.innerHTML = `
                <div class="card-student">${sessionData.studentName}</div>
                <div class="card-question">${shortQuestion}</div>
                <div class="card-performance">
                    <span>${Math.round(sessionData.totalTime / 1000)}s</span>
                    <span class="performance-score">${scoreText}</span>
                </div>
            `;
            
            // 点击事件 - 显示详细信息
            card.onclick = () => showCardDetail(sessionData);
            
            cardsArea.appendChild(card);
            
            // 存储卡片信息
            answeredQuestionCards.push({
                ...sessionData,
                position: { x, y },
                id: Date.now() + Math.random()
            });
            
            saveToLocalStorage();
        }

        // 显示卡片详细信息
        function showCardDetail(sessionData) {
            const modal = document.getElementById('cardDetailModal');
            if (!modal) {
                createCardDetailModal();
            }
            
            const content = document.getElementById('cardDetailContent');
            
            const sessionDate = new Date(sessionData.timestamp).toLocaleString('zh-CN');
            const thinkingTime = Math.round(sessionData.thinkingTime / 1000);
            const answeringTime = Math.round(sessionData.answeringTime / 1000);
            const totalTime = Math.round(sessionData.totalTime / 1000);
            
            let detailHTML = `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">
                        <i class="fas fa-user"></i> ${sessionData.studentName} 的答题详情
                    </h4>
                    <p style="color: #666; font-size: 0.9rem;">${sessionDate}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h5 style="color: #667eea; margin-bottom: 10px;">
                        <i class="fas fa-question-circle"></i> 题目内容
                    </h5>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; line-height: 1.6;">
                        ${sessionData.questions.join('<br><br>')}
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 15px; background: #e3f2fd; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: #1976d2;">${thinkingTime}s</div>
                        <div style="font-size: 0.8rem; color: #666;">思考时间</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #fff3e0; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: #f57c00;">${answeringTime}s</div>
                        <div style="font-size: 0.8rem; color: #666;">答题时间</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f3e5f5; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: bold; color: #7b1fa2;">${totalTime}s</div>
                        <div style="font-size: 0.8rem; color: #666;">总用时</div>
                    </div>
                </div>
            `;
            
            if (sessionData.evaluation) {
                const avgScore = calculateEvaluationScore(sessionData.evaluation);
                detailHTML += `
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #667eea; margin-bottom: 10px;">
                            <i class="fas fa-star"></i> 表现评估 (平均: ${avgScore.toFixed(1)}/5.0)
                        </h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;">
                            <div style="text-align: center; padding: 10px; background: #f0f8ff; border-radius: 8px;">
                                <div style="font-size: 0.7rem; color: #666;">流畅度</div>
                                <div style="font-weight: bold; color: #667eea;">${sessionData.evaluation.fluency || 'N/A'}</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #f0f8ff; border-radius: 8px;">
                                <div style="font-size: 0.7rem; color: #666;">深度</div>
                                <div style="font-weight: bold; color: #667eea;">${sessionData.evaluation.depth || 'N/A'}</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #f0f8ff; border-radius: 8px;">
                                <div style="font-size: 0.7rem; color: #666;">完整性</div>
                                <div style="font-weight: bold; color: #667eea;">${sessionData.evaluation.completeness || 'N/A'}</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #f0f8ff; border-radius: 8px;">
                                <div style="font-size: 0.7rem; color: #666;">准确性</div>
                                <div style="font-weight: bold; color: #667eea;">${sessionData.evaluation.accuracy || 'N/A'}</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #f0f8ff; border-radius: 8px;">
                                <div style="font-size: 0.7rem; color: #666;">逻辑性</div>
                                <div style="font-weight: bold; color: #667eea;">${sessionData.evaluation.logic || 'N/A'}</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #f0f8ff; border-radius: 8px;">
                                <div style="font-size: 0.7rem; color: #666;">表达力</div>
                                <div style="font-weight: bold; color: #667eea;">${sessionData.evaluation.expression || 'N/A'}</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #f0f8ff; border-radius: 8px;">
                                <div style="font-size: 0.7rem; color: #666;">应变力</div>
                                <div style="font-weight: bold; color: #667eea;">${sessionData.evaluation.adaptability || 'N/A'}</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #f0f8ff; border-radius: 8px;">
                                <div style="font-size: 0.7rem; color: #666;">整体印象</div>
                                <div style="font-weight: bold; color: #667eea;">${sessionData.evaluation.overall || 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                detailHTML += `
                    <div style="text-align: center; color: #999; padding: 20px;">
                        <i class="fas fa-info-circle"></i> 本次练习暂无评估记录
                    </div>
                `;
            }
            
            content.innerHTML = detailHTML;
            document.getElementById('cardDetailModal').style.display = 'block';
        }

        // 创建卡片详情模态框
        function createCardDetailModal() {
            const modalHTML = `
                <div class="modal" id="cardDetailModal">
                    <div class="modal-content">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3><i class="fas fa-info-circle"></i> 答题详情</h3>
                            <button class="btn btn-secondary" onclick="closeModal('cardDetailModal')" style="padding: 8px 12px;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="cardDetailContent"></div>
                        <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="closeModal('cardDetailModal')">
                                <i class="fas fa-times"></i> 关闭
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // 渲染已保存的答题卡片
        function renderAnsweredQuestionCards() {
            const cardsArea = document.getElementById('questionCardsArea');
            cardsArea.innerHTML = ''; // 清空现有卡片
            
            answeredQuestionCards.forEach(cardData => {
                const card = document.createElement('div');
                card.className = 'answered-question-card';
                card.style.left = cardData.position.x + 'px';
                card.style.top = cardData.position.y + 'px';
                
                const avgScore = cardData.evaluation ? calculateEvaluationScore(cardData.evaluation) : 0;
                const scoreText = avgScore > 0 ? avgScore.toFixed(1) : '--';
                
                const shortQuestion = cardData.questions[0].length > 20 ? 
                    cardData.questions[0].substring(0, 20) + '...' : cardData.questions[0];
                
                card.innerHTML = `
                    <div class="card-student">${cardData.studentName}</div>
                    <div class="card-question">${shortQuestion}</div>
                    <div class="card-performance">
                        <span>${Math.round(cardData.totalTime / 1000)}s</span>
                        <span class="performance-score">${scoreText}</span>
                    </div>
                `;
                
                card.onclick = () => showCardDetail(cardData);
                cardsArea.appendChild(card);
            });
        }

        // 重新开始
        function resetAll() {
            // 重置当前题目和学员
            currentQuestionSet = [];
            currentQuestionIndex = 0;
            
            // 退出聚焦模式
            if (isFocusMode) {
                exitFocusMode();
            }
            
            // 重置题目显示
            document.getElementById('questionContent').innerHTML = `
                <div class="question-placeholder">
                    <i class="fas fa-question-circle"></i>
                    <div>先点名，再抽题，今天轮到你练习</div>
                    <div style="margin-top: 10px; font-size: 0.9rem; opacity: 0.7;">支持1-5题套题模式</div>
                </div>
            `;
            
            // 重置计时器
            resetTimer();
            
            // 隐藏答案
            hideAnswerKey();
            
            // 清除评估
            clearEvaluation();
        }

        // 评估功能
        function setupEvaluationHandlers() {
            document.querySelectorAll('.evaluation-option').forEach(option => {
                option.addEventListener('click', function() {
                    const type = this.dataset.type;
                    const value = this.dataset.value;
                    
                    // 清除同类型的其他选择
                    document.querySelectorAll(`[data-type="${type}"]`).forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // 选中当前选项
                    this.classList.add('selected');
                    currentEvaluation[type] = value;
                });
            });
        }

        function clearEvaluation() {
            document.querySelectorAll('.evaluation-option').forEach(option => {
                option.classList.remove('selected');
            });
            currentEvaluation = {
                fluency: null,
                depth: null,
                completeness: null,
                accuracy: null,
                logic: null,
                expression: null,
                adaptability: null,
                overall: null
            };
        }

        function saveEvaluation() {
            if (!currentStudent) {
                alert('请先选择学员！');
                return;
            }
            
            const hasEvaluation = Object.values(currentEvaluation).some(val => val !== null);
            if (!hasEvaluation) {
                alert('请至少选择一项评估！');
                return;
            }
            
            // 保存评估到当前学员
            const evaluation = {
                ...currentEvaluation,
                questions: currentQuestionSet.map(q => q.question),
                timestamp: new Date(),
                thinkingTime: currentSessionTimes.thinkingTime,
                answeringTime: currentSessionTimes.answeringTime,
                mode: questionMode,
                questionTimes: currentSessionTimes.questionTimes
            };
            
            if (!currentStudent.evaluations) {
                currentStudent.evaluations = [];
            }
            currentStudent.evaluations.push(evaluation);
            
            // 更新成长得分
            currentStudent.growthScore = calculateStudentAvgScore(currentStudent);
            
            // 创建答题卡片
            const cardData = {
                studentName: currentStudent.name,
                questions: currentQuestionSet.map(q => q.question),
                categories: currentQuestionSet.map(q => q.category),
                thinkingTime: currentSessionTimes.thinkingTime,
                answeringTime: currentSessionTimes.answeringTime,
                totalTime: currentSessionTimes.thinkingTime + currentSessionTimes.answeringTime,
                evaluation: evaluation,
                timestamp: new Date()
            };
            
            createAnsweredQuestionCard(cardData);
            
            saveToLocalStorage();
            alert('评估已保存！');
            clearEvaluation();
            closeEvaluationModal();
            
            // 更新学员列表显示
            updateStudentList();
        }

        function showEvaluationModal() {
            document.getElementById('evaluationModal').style.display = 'flex';
        }

        function closeEvaluationModal() {
            document.getElementById('evaluationModal').style.display = 'none';
        }

        // 计时器功能 - 优化多题计时
        function resetTimerDisplay() {
            const savedSettings = localStorage.getItem('interviewSystemSettings');
            let thinkingTime = 30;
            
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                thinkingTime = settings.thinkingTime || 30;
            }
            
            if (timerPhase === 'waiting') {
                document.getElementById('timerDisplay').textContent = formatTime(thinkingTime);
                
                // 如果在聚焦模式，同步更新
                if (isFocusMode) {
                    const focusDisplay = document.querySelector('#focusTimer #timerDisplay');
                    if (focusDisplay) {
                        focusDisplay.textContent = formatTime(thinkingTime);
                    }
                }
            }
        }

        function startThinkingTimer() {
            if (timerPhase !== 'waiting') return;
            
            timerPhase = 'thinking';
            currentSessionTimes.thinkingStartTime = Date.now();
            
            updateTimerPhaseDisplay('thinking');
            updateTimerStatus('thinking');
            updateButtonStates();
            
            const savedSettings = localStorage.getItem('interviewSystemSettings');
            let thinkingTime = 30;
            
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                thinkingTime = settings.thinkingTime || 30;
            }
            
            startCountdown(thinkingTime, () => {
                // 思考时间结束，自动切换到答题阶段
                currentSessionTimes.thinkingTime = thinkingTime * 1000;
                startAnsweringTimer();
            });
        }

        function startAnsweringTimer() {
            if (timerPhase === 'thinking') {
                // 从思考阶段切换到答题阶段
                pauseTimer();
                if (currentSessionTimes.thinkingStartTime) {
                    currentSessionTimes.thinkingTime = Date.now() - currentSessionTimes.thinkingStartTime;
                }
            }
            
            timerPhase = 'answering';
            currentSessionTimes.answeringStartTime = Date.now();
            
            updateTimerPhaseDisplay('answering');
            updateTimerStatus('answering');
            updateButtonStates();
            
            const savedSettings = localStorage.getItem('interviewSystemSettings');
            let answeringTime = 4;
            
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                answeringTime = settings.answeringTime || 4;
            }
            
            startCountdown(answeringTime * 60, () => {
                // 答题时间结束
                alert('答题时间到！');
                finishAnswering();
            });
        }

        function finishAnswering() {
            if (timerPhase !== 'answering') return;
            pauseTimer();
            if (currentSessionTimes.answeringStartTime) {
                const currentAnsweringTime = Date.now() - currentSessionTimes.answeringStartTime;
                currentSessionTimes.answeringTime += currentAnsweringTime;
            }
            if (currentQuestionSet.length > 1 && currentQuestionIndex < currentQuestionSet.length - 1) {
                currentQuestionIndex++;
                displayQuestionSet();
                timerPhase = 'waiting';
                currentSessionTimes.thinkingStartTime = null;
                currentSessionTimes.answeringStartTime = null;
                updateTimerPhaseDisplay('waiting');
                updateTimerStatus('waiting');
                updateButtonStates();
                resetTimerDisplay();
                document.getElementById('finishBtnText').textContent =
                    currentQuestionIndex === currentQuestionSet.length - 1 ? '完成' : '下一题';
                alert(`第${currentQuestionIndex}题完成！请继续第${currentQuestionIndex + 1}题。`);
            } else {
                timerPhase = 'finished';
                updateTimerPhaseDisplay('finished');
                updateTimerStatus('finished');
                updateButtonStates();
                showEvaluationModal();
                recordCurrentSession();
            }
        }

        function startCountdown(totalSeconds, onComplete) {
            if (isTimerRunning) return;
            
            startTime = Date.now();
            isTimerRunning = true;
            
            timer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const remaining = Math.max(0, totalSeconds - elapsed);
                
                const timeText = formatTime(remaining);
                document.getElementById('timerDisplay').textContent = timeText;
                
                // 如果在聚焦模式，同步更新
                if (isFocusMode) {
                    const focusDisplay = document.querySelector('#focusTimer #timerDisplay');
                    if (focusDisplay) {
                        focusDisplay.textContent = timeText;
                    }
                }
                
                if (remaining === 0) {
                    pauseTimer();
                    if (onComplete) onComplete();
                }
            }, 1000);
        }

        function pauseTimer() {
            isTimerRunning = false;
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
        }

        function resetTimer() {
            pauseTimer();
            startTime = null;
            timerPhase = 'waiting';
            currentSessionTimes = {
                thinkingTime: 0,
                answeringTime: 0,
                thinkingStartTime: null,
                answeringStartTime: null
            };
            
            updateTimerPhaseDisplay('waiting');
            updateTimerStatus('waiting');
            updateButtonStates();
            resetTimerDisplay();
            
            // 重置完成按钮文本
            document.getElementById('finishBtnText').textContent = '完成';
        }

        function updateTimerPhaseDisplay(phase) {
            const phaseElement = document.getElementById('timerPhase');
            const phaseConfig = {
                waiting: { icon: 'fas fa-hourglass-start', text: '等待开始', color: '#95a5a6' },
                thinking: { icon: 'fas fa-brain', text: '思考阶段', color: '#3498db' },
                answering: { icon: 'fas fa-microphone', text: '答题阶段', color: '#e74c3c' },
                finished: { icon: 'fas fa-check-circle', text: '答题完成', color: '#27ae60' }
            };
            
            const config = phaseConfig[phase];
            phaseElement.innerHTML = `<i class="${config.icon}"></i><span>${config.text}</span>`;
            phaseElement.style.color = config.color;
            
            // 如果在聚焦模式，同步更新
            if (isFocusMode) {
                const focusPhase = document.querySelector('#focusTimer #timerPhase');
                if (focusPhase) {
                    focusPhase.innerHTML = phaseElement.innerHTML;
                    focusPhase.style.color = config.color;
                }
            }
        }

        function updateButtonStates() {
            const thinkingBtn = document.getElementById('thinkingBtn');
            const answeringBtn = document.getElementById('answeringBtn');
            const finishBtn = document.getElementById('finishBtn');
            
            // 重置所有按钮状态
            thinkingBtn.disabled = false;
            answeringBtn.disabled = false;
            finishBtn.disabled = false;
            
            switch (timerPhase) {
                case 'waiting':
                    answeringBtn.disabled = true;
                    finishBtn.disabled = true;
                    break;
                case 'thinking':
                    thinkingBtn.disabled = true;
                    finishBtn.disabled = true;
                    break;
                case 'answering':
                    thinkingBtn.disabled = true;
                    answeringBtn.disabled = true;
                    break;
                case 'finished':
                    thinkingBtn.disabled = true;
                    answeringBtn.disabled = true;
                    finishBtn.disabled = true;
                    break;
            }
            
            // 如果在聚焦模式，同步更新按钮状态
            if (isFocusMode) {
                const focusThinkingBtn = document.querySelector('#focusTimer #thinkingBtn');
                const focusAnsweringBtn = document.querySelector('#focusTimer #answeringBtn');
                const focusFinishBtn = document.querySelector('#focusTimer #finishBtn');
                
                if (focusThinkingBtn) focusThinkingBtn.disabled = thinkingBtn.disabled;
                if (focusAnsweringBtn) focusAnsweringBtn.disabled = answeringBtn.disabled;
                if (focusFinishBtn) focusFinishBtn.disabled = finishBtn.disabled;
            }
        }

        // updateSessionTimeDisplay函数已移除，因为本轮记录功能已被移除

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function recordCurrentSession() {
            if (currentStudent && currentQuestionSet.length > 0) {
                const session = {
                    questions: currentQuestionSet.map(q => q.question),
                    categories: currentQuestionSet.map(q => q.category),
                    mode: questionMode,
                    thinkingTime: currentSessionTimes.thinkingTime,
                    answeringTime: currentSessionTimes.answeringTime,
                    totalTime: currentSessionTimes.thinkingTime + currentSessionTimes.answeringTime,
                    timestamp: new Date()
                };
                
                currentStudent.sessions.push(session);
                currentStudent.totalThinkingTime += currentSessionTimes.thinkingTime;
                currentStudent.totalAnsweringTime += currentSessionTimes.answeringTime;
                
                // 立即更新学员列表显示
                updateStudentList();
                updateAllStatistics();
                saveToLocalStorage();
                
                // 显示完成提示
                setTimeout(() => {
                    const modeText = currentQuestionSet.length + '题套题';
                    alert(`${currentStudent.name} ${modeText}练习完成！\n总思考时间：${Math.round(currentSessionTimes.thinkingTime / 1000)}秒\n总答题时间：${Math.round(currentSessionTimes.answeringTime / 1000)}秒`);
                }, 500);
            }
        }

        // 学员管理功能
        function addNewStudent() {
            const nameInput = document.getElementById('newStudentName');
            const idInput = document.getElementById('newStudentId');
            const name = nameInput.value.trim();
            const id = idInput.value.trim();
            
            if (name) {
                // 检查是否重名
                if (students.some(s => s.name === name)) {
                    alert('学员姓名已存在！');
                    return;
                }
                
                students.push({
                    name: name,
                    id: id || `STU${students.length + 1}`,
                    count: 0,
                    totalThinkingTime: 0,
                    totalAnsweringTime: 0,
                    sessions: [],
                    evaluations: [],
                    growthScore: 0
                });
                
                nameInput.value = '';
                idInput.value = '';
                updateStudentList();
                updateModalStudentList();
                updateAllStatistics();
                saveToLocalStorage();
                alert('学员添加成功！');
            }
        }

        function batchAddStudents() {
            const textarea = document.getElementById('studentTextArea');
            const names = textarea.value.split('\n').map(name => name.trim()).filter(name => name);
            
            let addedCount = 0;
            names.forEach(name => {
                if (!students.some(s => s.name === name)) {
                    students.push({
                        name: name,
                        id: `STU${students.length + 1}`,
                        count: 0,
                        totalThinkingTime: 0,
                        totalAnsweringTime: 0,
                        sessions: [],
                        evaluations: [],
                        growthScore: 0
                    });
                    addedCount++;
                }
            });
            
            if (addedCount > 0) {
                alert(`成功添加 ${addedCount} 名学员！`);
                textarea.value = '';
                updateStudentList();
                updateModalStudentList();
                updateAllStatistics();
                saveToLocalStorage();
            } else {
                alert('没有新增学员，请检查名单是否重复！');
            }
        }

        function updateModalStudentList() {
            const listElement = document.getElementById('modalStudentList');
            if (!listElement) return;
            
            listElement.innerHTML = students.map((student, index) => {
                const avgScore = calculateStudentAvgScore(student);
                const growthTrend = calculateGrowthTrend(student);
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; margin: 8px 0; background: #f8f9fa; border-radius: 12px; border-left: 4px solid #667eea;">
                        <div>
                            <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 5px;">${student.name} (${student.id})</div>
                            <div style="font-size: 0.85rem; color: #666; display: flex; flex-direction: column; gap: 2px;">
                                <div>抽题${student.count}次 · 练习${student.sessions.length}次 · 评估${student.evaluations ? student.evaluations.length : 0}次</div>
                                ${avgScore > 0 ? `<div>平均评分: ${avgScore}/5.0 ${growthTrend > 0 ? '📈 进步中' : growthTrend < 0 ? '📉 需关注' : '➡️ 稳定'}</div>` : '<div>暂无评估数据</div>'}
                            </div>
                        </div>
                        <button class="btn btn-danger" onclick="removeStudent(${index})" style="padding: 8px 12px; font-size: 12px;">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </div>
                `;
            }).join('');
        }

        function removeStudent(index) {
            if (confirm('确定要删除这个学员吗？')) {
                students.splice(index, 1);
                updateStudentList();
                updateModalStudentList();
                updateAllStatistics();
                saveToLocalStorage();
            }
        }

        function clearAllStudents() {
            if (confirm('确定要清空所有学员吗？此操作不可恢复！')) {
                students = [];
                currentStudent = null;
                updateStudentList();
                updateModalStudentList();
                updateAllStatistics();
                saveToLocalStorage();
                
                // 更新分析指示器
                updateAnalysisIndicators();
                
                alert('所有学员已清空！');
            }
        }

        function resetAllStudentStats() {
            if (confirm('确定要重置所有学员的统计数据吗？此操作不可恢复！')) {
                students.forEach(student => {
                    student.count = 0;
                    student.totalThinkingTime = 0;
                    student.totalAnsweringTime = 0;
                    student.sessions = [];
                    student.evaluations = [];
                    student.growthScore = 0;
                });
                
                sessionData = [];
                currentStudent = null;
                answeredQuestionCards = [];
                
                updateStudentList();
                updateModalStudentList();
                updateAllStatistics();
                renderAnsweredQuestionCards();
                saveToLocalStorage();
                
                // 更新分析指示器
                updateAnalysisIndicators();
                
                alert('所有学员统计数据已重置！');
            }
        }

        // 题库管理
        function updateQuestionList() {
            const listElement = document.getElementById('questionList');
            if (!listElement) return;
            
            if (questions.length === 0) {
                listElement.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 20px;">
                        <i class="fas fa-plus" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.3;"></i>
                        <div>暂无题目</div>
                        <div style="font-size: 0.8rem; margin-top: 5px;">请添加题目或上传题库</div>
                    </div>
                `;
                return;
            }
            
            listElement.innerHTML = questions.map((question, index) => `
                <div class="question-item">
                    <div class="question-item-header">
                        <div class="question-item-title">${question.question.substring(0, 50)}${question.question.length > 50 ? '...' : ''}</div>
                        <div class="question-item-actions">
                            <button class="question-item-btn btn-edit" onclick="editQuestion(${index})">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="question-item-btn btn-delete" onclick="deleteQuestion(${index})">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                    <div class="question-item-content">${question.question}</div>
                    <div class="question-item-meta">
                        <span class="question-item-tag">${question.province} ${question.city}</span>
                        <span class="question-item-tag">${question.year}</span>
                        <span class="question-item-tag">${question.hospital}</span>
                        <span class="question-item-tag">${question.category}</span>
                    </div>
                </div>
            `).join('');
        }

        function showAddQuestionForm() {
            document.getElementById('addQuestionModal').style.display = 'block';
        }

        function saveNewQuestion() {
            const form = document.getElementById('addQuestionForm');
            
            const newQuestion = {
                province: document.getElementById('newQuestionProvince').value.trim(),
                city: document.getElementById('newQuestionCity').value.trim(),
                year: document.getElementById('newQuestionYear').value.trim(),
                hospital: document.getElementById('newQuestionHospital').value.trim(),
                category: document.getElementById('newQuestionCategory').value.trim(),
                question: document.getElementById('newQuestionText').value.trim(),
                keyPoints: document.getElementById('newQuestionKeyPoints').value.trim(),
                analysis: document.getElementById('newQuestionAnalysis').value.trim()
            };
            
            // 验证必填字段
            if (!newQuestion.province || !newQuestion.city || !newQuestion.year || 
                !newQuestion.hospital || !newQuestion.category || !newQuestion.question || 
                !newQuestion.keyPoints || !newQuestion.analysis) {
                alert('请填写所有必填字段！');
                return;
            }
            
            questions.push(newQuestion);
            updateModernFilterOptions();
            updateAllStatistics();
            updateQuestionList();
            saveToLocalStorage();
            
            // 清空表单
            form.reset();
            closeModal('addQuestionModal');
            
            alert('题目添加成功！');
        }

        function editQuestion(index) {
            editingQuestionIndex = index;
            const question = questions[index];
            
            document.getElementById('editQuestionProvince').value = question.province;
            document.getElementById('editQuestionCity').value = question.city;
            document.getElementById('editQuestionYear').value = question.year;
            document.getElementById('editQuestionHospital').value = question.hospital;
            document.getElementById('editQuestionCategory').value = question.category;
            document.getElementById('editQuestionText').value = question.question;
            document.getElementById('editQuestionKeyPoints').value = question.keyPoints;
            document.getElementById('editQuestionAnalysis').value = question.analysis;
            
            document.getElementById('editQuestionModal').style.display = 'block';
        }

        function saveEditedQuestion() {
            if (editingQuestionIndex < 0) return;
            
            const editedQuestion = {
                province: document.getElementById('editQuestionProvince').value.trim(),
                city: document.getElementById('editQuestionCity').value.trim(),
                year: document.getElementById('editQuestionYear').value.trim(),
                hospital: document.getElementById('editQuestionHospital').value.trim(),
                category: document.getElementById('editQuestionCategory').value.trim(),
                question: document.getElementById('editQuestionText').value.trim(),
                keyPoints: document.getElementById('editQuestionKeyPoints').value.trim(),
                analysis: document.getElementById('editQuestionAnalysis').value.trim()
            };
            
            // 验证必填字段
            if (!editedQuestion.province || !editedQuestion.city || !editedQuestion.year || 
                !editedQuestion.hospital || !editedQuestion.category || !editedQuestion.question || 
                !editedQuestion.keyPoints || !editedQuestion.analysis) {
                alert('请填写所有必填字段！');
                return;
            }
            
            questions[editingQuestionIndex] = editedQuestion;
            updateModernFilterOptions();
            updateAllStatistics();
            updateQuestionList();
            saveToLocalStorage();
            
            closeModal('editQuestionModal');
            editingQuestionIndex = -1;
            
            alert('题目修改成功！');
        }

        function deleteQuestion(index) {
            if (confirm('确定要删除这个题目吗？')) {
                questions.splice(index, 1);
                updateModernFilterOptions();
                updateAllStatistics();
                updateQuestionList();
                saveToLocalStorage();
                alert('题目删除成功！');
            }
        }

        function clearAllQuestions() {
            if (confirm('确定要清空题库吗？此操作不可恢复！')) {
                questions = [];
                currentQuestionSet = [];
                updateModernFilterOptions();
                updateAllStatistics();
                updateQuestionList();
                saveToLocalStorage();
                
                // 重置题目显示
                document.getElementById('questionContent').innerHTML = `
                    <div class="question-placeholder">
                        <i class="fas fa-question-circle"></i>
                        <div>题库已清空，请先上传题库</div>
                    </div>
                `;
                
                alert('题库已清空！');
            }
        }

        // 统计数据更新
        function updateAllStatistics() {
            updateQuestionBankStats();
            updateFilterStats();
        }

        function updateQuestionBankStats() {
            const bankTotalElement = document.getElementById('bankTotalQuestions');
            const bankCategoriesElement = document.getElementById('bankCategories');
            const bankProvincesElement = document.getElementById('bankProvinces');
            const bankYearsElement = document.getElementById('bankYears');
            
            if (bankTotalElement) bankTotalElement.textContent = questions.length;
            
            const categories = new Set(questions.map(q => q.category).filter(Boolean));
            if (bankCategoriesElement) bankCategoriesElement.textContent = categories.size;
            
            const provinces = new Set(questions.map(q => q.province).filter(Boolean));
            if (bankProvincesElement) bankProvincesElement.textContent = provinces.size;
            
            const years = new Set(questions.map(q => q.year).filter(Boolean));
            if (bankYearsElement) bankYearsElement.textContent = years.size;
        }

        // 设置相关
        function openSettingsModal() {
            updateModalStudentList();
            updateQuestionList();
            document.getElementById('settingsModal').style.display = 'block';
        }

        function openAnalysisModal() {
            generateAnalysisReport();
            document.getElementById('analysisModal').style.display = 'block';
        }

        function switchSettingsTab(tabName) {
            // 移除所有活动状态
            document.querySelectorAll('.settings-modal .tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.settings-modal .tab-content').forEach(content => content.classList.remove('active'));
            
            // 激活选中的标签页
            event.target.classList.add('active');
            
            if (tabName === 'students') {
                document.getElementById('studentsTab').classList.add('active');
                updateModalStudentList();
            } else if (tabName === 'questions') {
                document.getElementById('questionsTab').classList.add('active');
                updateQuestionBankStats();
                updateQuestionList();
            } else if (tabName === 'system') {
                document.getElementById('systemTab').classList.add('active');
            }
        }

        function generateAnalysisReport() {
            // 如果有选中的学员，显示学员详细分析
            if (currentStudent) {
                showStudentDetailAnalysis(currentStudent);
                return;
            }
            
            // 否则显示整体分析报告
            const totalSessions = students.reduce((sum, s) => sum + s.sessions.length, 0);
            const totalStudents = students.length;
            const totalEvaluations = students.reduce((sum, s) => sum + (s.evaluations ? s.evaluations.length : 0), 0);
            const totalQuestions = questions.length;
            
            // 套题模式统计
            const singleModeCount = sessionData.filter(s => s.mode === 'single').length;
            const doubleModeCount = sessionData.filter(s => s.mode === 'double').length;
            const tripleModeCount = sessionData.filter(s => s.mode === 'triple').length;
            const quadModeCount = sessionData.filter(s => s.mode === 'quad').length;
            const pentaModeCount = sessionData.filter(s => s.mode === 'penta').length;
            
            // 学员排名（按综合表现）
            const studentRanking = students.map(student => ({
                name: student.name,
                sessions: student.sessions.length,
                avgThinking: student.sessions.length > 0 ? Math.round(student.totalThinkingTime / student.sessions.length / 1000) : 0,
                avgAnswering: student.sessions.length > 0 ? Math.round(student.totalAnsweringTime / student.sessions.length / 1000) : 0,
                evaluations: student.evaluations ? student.evaluations.length : 0,
                avgScore: calculateStudentAvgScore(student),
                growthTrend: calculateGrowthTrend(student),
                totalTime: Math.round((student.totalThinkingTime + student.totalAnsweringTime) / 1000)
            })).sort((a, b) => {
                // 综合排序：评分优先，练习次数次之
                if (a.avgScore !== b.avgScore) return b.avgScore - a.avgScore;
                return b.sessions - a.sessions;
            });
            
            const content = `
                <div style="margin-bottom: 30px;">
                    <h4><i class="fas fa-chart-bar"></i> 整体统计概览</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin: 20px 0;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; text-align: center;">
                            <div style="font-size: 1.8rem; font-weight: bold;">${totalQuestions}</div>
                            <div style="font-size: 0.8rem; opacity: 0.9;">题库总量</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; text-align: center;">
                            <div style="font-size: 1.8rem; font-weight: bold;">${totalSessions}</div>
                            <div style="font-size: 0.8rem; opacity: 0.9;">总练习次数</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; text-align: center;">
                            <div style="font-size: 1.8rem; font-weight: bold;">${totalStudents}</div>
                            <div style="font-size: 0.8rem; opacity: 0.9;">参与学员</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; text-align: center;">
                            <div style="font-size: 1.8rem; font-weight: bold;">${totalEvaluations}</div>
                            <div style="font-size: 0.8rem; opacity: 0.9;">总评估次数</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; text-align: center;">
                            <div style="font-size: 1.8rem; font-weight: bold;">${answeredQuestionCards.length}</div>
                            <div style="font-size: 0.8rem; opacity: 0.9;">完成答题卡片</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h4><i class="fas fa-layer-group"></i> 套题模式统计</h4>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin: 20px 0;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #27ae60;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #27ae60;">${singleModeCount}</div>
                            <div style="font-size: 0.8rem; color: #666;">单题练习</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #3498db;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #3498db;">${doubleModeCount}</div>
                            <div style="font-size: 0.8rem; color: #666;">两题套题</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #e74c3c;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #e74c3c;">${tripleModeCount}</div>
                            <div style="font-size: 0.8rem; color: #666;">三题套题</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #f39c12;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #f39c12;">${quadModeCount}</div>
                            <div style="font-size: 0.8rem; color: #666;">四题套题</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #9b59b6;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #9b59b6;">${pentaModeCount}</div>
                            <div style="font-size: 0.8rem; color: #666;">五题套题</div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 30px;">
                    <h4><i class="fas fa-trophy"></i> 学员综合排行</h4>
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef;">排名</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef;">姓名</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef;">练习次数</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef;">平均评分</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef;">成长趋势</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef;">平均思考时间</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef;">平均答题时间</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef;">评估次数</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${studentRanking.map((student, index) => {
                                const trendIcon = student.growthTrend > 0 ? '📈' : student.growthTrend < 0 ? '📉' : '➡️';
                                const trendText = student.growthTrend > 0 ? '进步中' : student.growthTrend < 0 ? '需关注' : '稳定';
                                
                                return `
                                    <tr style="border-bottom: 1px solid #e9ecef;">
                                        <td style="padding: 12px;">${index + 1}</td>
                                        <td style="padding: 12px; font-weight: 600;">${student.name}</td>
                                        <td style="padding: 12px;">${student.sessions}</td>
                                        <td style="padding: 12px;">${student.avgScore}/5.0</td>
                                        <td style="padding: 12px;">${trendIcon} ${trendText}</td>
                                        <td style="padding: 12px;">${student.avgThinking}s</td>
                                        <td style="padding: 12px;">${student.avgAnswering}s</td>
                                        <td style="padding: 12px;">${student.evaluations}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('analysisContent').innerHTML = content;
        }

        function exportAnalysisReport() {
            // 生成CSV格式的分析报告
            const data = students.map(student => ({
                姓名: student.name,
                学号: student.id,
                被抽次数: student.count,
                完整练习次数: student.sessions.length,
                总思考时间: Math.round(student.totalThinkingTime / 1000),
                总答题时间: Math.round(student.totalAnsweringTime / 1000),
                平均思考时间: student.sessions.length > 0 ? Math.round(student.totalThinkingTime / student.sessions.length / 1000) : 0,
                平均答题时间: student.sessions.length > 0 ? Math.round(student.totalAnsweringTime / student.sessions.length / 1000) : 0,
                评估次数: student.evaluations ? student.evaluations.length : 0,
                平均评分: calculateStudentAvgScore(student),
                成长趋势: calculateGrowthTrend(student)
            }));
            
            const csv = [
                Object.keys(data[0]).join(','),
                ...data.map(row => Object.values(row).join(','))
            ].join('\n');
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `面试练习分析报告_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function exportAllData() {
            const data = {
                questions,
                students,
                sessionData,
                answeredQuestionCards,
                exportTime: new Date().toISOString(),
                version: '3.2'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `面试系统数据_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function clearAllData() {
            if (confirm('确定要清空所有数据吗？此操作不可恢复！')) {
                questions = [];
                students = [];
                sessionData = [];
                currentQuestionSet = [];
                currentStudent = null;
                answeredQuestionCards = [];
                
                updateModernFilterOptions();
                updateAllStatistics();
                updateStudentList();
                updateModalStudentList();
                updateQuestionList();
                renderAnsweredQuestionCards();
                saveToLocalStorage();
                
                // 更新分析指示器
                updateAnalysisIndicators();
                
                // 重置题目显示
                document.getElementById('questionContent').innerHTML = `
                    <div class="question-placeholder">
                        <i class="fas fa-question-circle"></i>
                        <div>先点名，再抽题，今天轮到你练习</div>
                        <div style="margin-top: 10px; font-size: 0.9rem; opacity: 0.7;">支持1-5题套题模式</div>
                    </div>
                `;
                
                alert('所有数据已清空！');
            }
        }

        // 模态框管理
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // 文件上传
        function setupFileUploads() {
            setupQuestionFileUpload();
            setupStudentFileUpload();
        }

        function setupQuestionFileUpload() {
            const fileUpload = document.getElementById('questionFileUpload');
            const fileInput = document.getElementById('csvFile');

            fileUpload.addEventListener('click', () => {
                fileInput.click();
            });

            fileUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUpload.classList.add('dragover');
            });

            fileUpload.addEventListener('dragleave', () => {
                fileUpload.classList.remove('dragover');
            });

            fileUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUpload.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleQuestionFileUpload(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleQuestionFileUpload(e.target.files[0]);
                }
            });
        }

        function setupStudentFileUpload() {
            const fileUpload = document.getElementById('studentFileUpload');
            const fileInput = document.getElementById('studentFile');

            fileUpload.addEventListener('click', () => {
                fileInput.click();
            });

            fileUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUpload.classList.add('dragover');
            });

            fileUpload.addEventListener('dragleave', () => {
                fileUpload.classList.remove('dragover');
            });

            fileUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUpload.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleStudentFileUpload(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleStudentFileUpload(e.target.files[0]);
                }
            });
        }

        function handleQuestionFileUpload(file) {
            if (!file.name.endsWith('.csv')) {
                alert('请选择CSV文件！');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    parseCSV(e.target.result);
                    alert('题库上传成功！');
                    updateModernFilterOptions();
                    updateAllStatistics();
                    updateQuestionList();
                    saveToLocalStorage();
                } catch (error) {
                    alert('文件解析失败：' + error.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        function handleStudentFileUpload(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    let names = [];
                    
                    if (file.name.endsWith('.csv')) {
                        const lines = content.split('\n');
                        names = lines.slice(1).map(line => line.split(',')[0].trim()).filter(name => name);
                    } else {
                        names = content.split('\n').map(name => name.trim()).filter(name => name);
                    }
                    
                    document.getElementById('studentTextArea').value = names.join('\n');
                    alert(`成功读取 ${names.length} 个学员姓名，请点击"批量添加"按钮确认添加。`);
                } catch (error) {
                    alert('文件解析失败：' + error.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            const newQuestions = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = parseCSVLine(line);
                if (values.length < headers.length) continue;
                
                const question = {};
                headers.forEach((header, index) => {
                    question[header] = values[index] || '';
                });
                
                // 映射字段
                const mappedQuestion = {
                    province: question['省'] || question['province'] || question['省份'] || '',
                    city: question['市'] || question['city'] || question['城市'] || '',
                    year: question['年份'] || question['year'] || '',
                    hospital: question['医院/单位'] || question['hospital'] || question['医院'] || question['单位'] || '',
                    category: question['AI 考点分类'] || question['category'] || question['知识点分类'] || question['分类'] || '',
                    question: question['题干优化'] || question['题目'] || question['question'] || '',
                    keyPoints: question['得分要点'] || question['keyPoints'] || question['答题要点'] || '',
                    analysis: question['参考解析'] || question['analysis'] || ''
                };
                
                if (mappedQuestion.question) {
                    newQuestions.push(mappedQuestion);
                }
            }
            
            questions = newQuestions;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim().replace(/"/g, ''));
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim().replace(/"/g, ''));
            return result;
        }

        // 点击模态框外部关闭
        window.addEventListener('click', function(e) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            // 关闭评估弹窗
            if (e.target === document.getElementById('evaluationModal')) {
                closeEvaluationModal();
            }
            
            // 关闭聚焦模式
            if (e.target === document.getElementById('focusMode')) {
                exitFocusMode();
            }
        });

        // ESC键关闭
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideAnswerKey();
                closeEvaluationModal();
                exitFocusMode();
                // 关闭所有模态框
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
                // 关闭抽人轮盘
                document.getElementById('studentRoulette').style.display = 'none';
                // 关闭抽题动画
                document.getElementById('questionRoulette').style.display = 'none';
            }
            
            // 快捷键
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'q':
                        e.preventDefault();
                        if (currentStudent) {
                            drawRandomQuestion(questionCount);
                        } else {
                            alert('请先随机抽选学员！');
                        }
                        break;
                    case 's':
                        e.preventDefault();
                        drawRandomStudent();
                        break;
                    case 'a':
                        e.preventDefault();
                        showAnswerKey();
                        break;
                    case 'r':
                        e.preventDefault();
                        resetAll();
                        break;
                    case 'f':
                        e.preventDefault();
                        if (currentQuestionSet.length > 0) {
                            if (isFocusMode) {
                                exitFocusMode();
                            } else {
                                enterFocusMode();
                            }
                        }
                        break;
                }
            }
        });

        // 定期保存数据
        setInterval(saveToLocalStorage, 30000); // 每30秒自动保存
    </script>
</body>
</html>

